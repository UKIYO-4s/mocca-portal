# 引き継ぎドキュメント: コードレビューと500エラー修正

**作成日**: 2026年1月1日
**担当**: Claude Code
**対象**: システム全体のサステナビリティ確認

---

## 概要

システム全体のコードレビューを実施し、500エラーの潜在的な原因を特定・修正しました。また、継続的な品質保証のためのAPIヘルスチェックテストを追加しました。

---

## 1. 発見・修正したバグ

### 1.1 高優先度: ActivityLogService の NULL エラー（修正済み）

**ファイル**: `app/Services/ActivityLogService.php`

**問題**: 招待登録時に `Auth::login()` 直後に `Auth::id()` を呼び出すと NULL が返される

**修正内容**:
```php
// Before
public function log(string $module, string $action, ?Model $target = null, ?string $description = null): ActivityLog
{
    return ActivityLog::create([
        'user_id' => Auth::id(),  // NULL になる可能性
        // ...
    ]);
}

// After
public function log(
    string $module,
    string $action,
    ?Model $target = null,
    ?string $description = null,
    ?int $userId = null  // 明示的にユーザーIDを渡せるように
): ActivityLog {
    return ActivityLog::create([
        'user_id' => $userId ?? Auth::id(),
        // ...
    ]);
}
```

### 1.2 高優先度: GuestPage リレーションの SQL エラー（修正済み）

**ファイル**: `app/Models/GuestPage.php`

**問題**: `belongsTo` に `where` 句を付けると間違ったテーブルをクエリする

**修正内容**:
```php
// Before (エラー発生)
public function banshirouReservation(): BelongsTo
{
    return $this->belongsTo(BanshirouReservation::class, 'reservation_id')
        ->where('reservation_type', 'banshirou');  // 誤: banshirou_reservationsテーブルにはこのカラムがない
}

// After
public function banshirouReservation(): BelongsTo
{
    return $this->belongsTo(BanshirouReservation::class, 'reservation_id');
}

// 代わりにアクセサで振り分け
public function getReservationAttribute()
{
    return match($this->reservation_type) {
        'banshirou' => $this->banshirouReservation,
        'mocca' => $this->moccaReservation,
        default => null,
    };
}
```

### 1.3 高優先度: Location モデルの shifts リレーション（修正済み）

**ファイル**:
- `app/Models/Location.php`
- `app/Modules/Location/Controllers/LocationController.php`
- `resources/js/Pages/Admin/Locations/Index.tsx`

**問題**: マイグレーション `2025_12_30_020405_simplify_shifts_table` で `shifts.location_id` が削除されたが、Location モデルで参照が残っていた

**修正内容**:
```php
// Location.php - shifts() リレーションを削除
// LocationController.php
$locations = Location::withCount(['inventoryItems'])  // 'shifts' を削除
    ->orderBy('name')
    ->get();
```

### 1.4 中優先度: MoccaReservationController のフィルタ未対応（修正済み）

**ファイル**: `app/Modules/Reservation/Controllers/MoccaReservationController.php`

**問題**: フロントエンドが `from/to` パラメータを送信しても、コントローラーは `date` のみ対応していた

**修正内容**:
```php
if ($request->filled('from') && $request->filled('to')) {
    $query->betweenDates($request->from, $request->to);
} elseif ($request->filled('date')) {
    $query->forDate($request->date);
}
```

### 1.5 中優先度: Reservation モデルの $appends 未設定（修正済み）

**ファイル**:
- `app/Modules/Reservation/Models/BanshirouReservation.php`
- `app/Modules/Reservation/Models/MoccaReservation.php`

**問題**: 計算属性（`formatted_phone`, `status_label` など）が Inertia レスポンスに含まれない

**修正内容**:
```php
// BanshirouReservation.php
protected $appends = [
    'formatted_phone',
    'phone_link',
    'status_label',
    'meal_option_label',
    'payment_method_label',
    'total_guests',
    'nights',
];

// MoccaReservation.php
protected $appends = [
    'type_label',
    'status_label',
    'formatted_phone',
    'phone_link',
    'formatted_arrival_time',
];
```

---

## 2. 追加したテスト

### APIヘルスチェックテスト

**ファイル**: `tests/Feature/ApiHealthCheckTest.php`

31のテストケースで主要エンドポイントの500エラー発生有無を確認:

| カテゴリ | テスト内容 |
|---------|-----------|
| 公開ルート | `/`, `/login` |
| 認証 | ダッシュボード、プロフィール |
| 予約 | Mocca/Banshirou 一覧・作成・フィルタ |
| 空き状況 | 一覧・データAPI |
| チェックリスト | 一覧・テンプレート（権限確認含む） |
| タイムカード | 一覧 |
| 在庫管理 | 一覧 |
| シフト | 一覧・カレンダー・マイシフト |
| お知らせ | 一覧 |
| 管理者 | 招待・拠点・ウォレット・チップ |
| ゲスト | 無効UUID |
| ウォレット | プロフィールウォレット |
| API | チップ・レビュー |

**実行方法**:
```bash
php artisan test --filter=ApiHealthCheckTest
```

**注意**: phpunit.xml を MySQL 接続に変更しています（SQLite はマイグレーション非互換のため）

---

## 3. 設定変更

### phpunit.xml

```xml
<!-- Before -->
<env name="DB_CONNECTION" value="sqlite"/>
<env name="DB_DATABASE" value=":memory:"/>

<!-- After -->
<env name="DB_CONNECTION" value="mysql"/>
<!-- Use existing MySQL database for testing -->
```

**理由**: マイグレーション `2025_12_30_020405_simplify_shifts_table` が SQLite 非互換（インデックス削除順序の問題）

---

## 4. コミット履歴

```
ea36250 fix: Locationモデルからshiftsリレーション削除（500エラー修正）
98ea7a9 fix: 予約機能の重大バグ修正
ecaef92 fix: 招待登録時のActivityLogバグ修正とNULL安全性強化
```

---

## 5. 今後の推奨事項

### 5.1 テストの拡充

現在のテストは「500エラーが発生しないこと」の確認のみ。より深いテストが必要な場合:

- **Laravel Dusk**: ブラウザ自動テスト（フォーム送信、JS動作確認）
- **PHPUnit Feature Tests**: データ作成・更新・削除のテスト

### 5.2 マイグレーションのSQLite互換性

今後のマイグレーションでは、インデックス削除はカラム削除の**前**に行うこと:
```php
// 正しい順序
Schema::table('shifts', function (Blueprint $table) {
    $table->dropIndex(['date', 'location_id']);  // 1. インデックス削除
});
Schema::table('shifts', function (Blueprint $table) {
    $table->dropColumn(['location_id']);  // 2. カラム削除
});
```

### 5.3 定期的なヘルスチェック

デプロイ後に以下を実行することを推奨:
```bash
php artisan test --filter=ApiHealthCheckTest
```

---

## 6. 関連ドキュメント

- `docs/08_引き継ぎ_20260101_Metamask連携.md` - 同日のMetamask連携実装
- `docs/07_引き継ぎ_20251231_外部予約連携.md` - 外部予約連携機能

---

## 7. 確認済み項目

- [x] 全122ルートの構文確認
- [x] PHPファイルの構文チェック（`php -l`）
- [x] 仮想サーバーでのHTTPテスト
- [x] モデルリレーションのTinkerテスト
- [x] APIヘルスチェックテスト（31テスト全パス）
- [x] 本番デプロイ完了
