# Mocca Portal 引き継ぎドキュメント - Metamask連携機能

**作成日:** 2026年1月1日 00:30 JST
**作成者:** Claude Code (Opus 4.5)

---

## 1. 実装概要

ウォレット設定ページにMetamask連携機能を追加。従来の手動入力に加え、Metamaskから直接ウォレットアドレスを取得・検証できるようになった。

---

## 2. 実装内容

### 2.1 機能一覧

| 機能 | 説明 |
|------|------|
| Metamask接続 | ボタンクリックでMetamaskからアドレスを自動取得 |
| 自動検証 | Metamask経由で取得したアドレスは自動的に「検証済み」 |
| 手動入力 | 従来通り`0x...`形式で直接入力も可能（未検証扱い） |
| 日本時間表示 | 登録日時をGMTから日本時間（Asia/Tokyo）に修正 |

### 2.2 変更ファイル

```
app/Http/Controllers/StaffWalletController.php
├── update() - connected_via_metamaskフラグ対応
├── edit() - 日本時間表示
├── show() - 日本時間表示
└── adminIndex() - 日本時間表示

resources/js/Pages/Profile/Wallet.tsx
├── connectMetamask() - Metamask接続処理
├── useForm - connected_via_metamaskフラグ追加
└── SVG - 完全版Metamaskロゴ
```

### 2.3 データフロー

```
[Metamask接続ボタン]
    ↓
[BrowserProvider(ethers.js)]
    ↓
[eth_requestAccounts]
    ↓
[アドレス取得 + connected_via_metamask=true]
    ↓
[フォーム送信]
    ↓
[Controller: is_verified=true で保存]
```

---

## 3. 技術詳細

### 3.1 フロントエンド（Wallet.tsx）

```typescript
// Metamask接続処理
const connectMetamask = async () => {
    const provider = new BrowserProvider(window.ethereum);
    const accounts = await provider.send('eth_requestAccounts', []);
    setData((prev) => ({
        ...prev,
        wallet_address: accounts[0],
        connected_via_metamask: true,  // 検証フラグ
    }));
};
```

### 3.2 バックエンド（StaffWalletController.php）

```php
// Metamask経由なら自動検証
$isVerified = $request->boolean('connected_via_metamask');

$wallet = StaffWallet::updateOrCreate(
    ['user_id' => $user->id],
    [
        'wallet_address' => strtolower($validated['wallet_address']),
        'is_verified' => $isVerified,
        'connected_at' => now(),
    ]
);
```

### 3.3 日本時間表示

```php
// 全箇所で timezone('Asia/Tokyo') を追加
'connected_at' => $wallet->connected_at?->timezone('Asia/Tokyo')->format('Y-m-d H:i'),
```

---

## 4. UI仕様

### 4.1 ウォレット設定ページ（/profile/wallet）

```
┌─────────────────────────────────────┐
│ ウォレット設定                        │
├─────────────────────────────────────┤
│                                     │
│  [🦊 Metamaskで接続]  ← オレンジボタン │
│                                     │
│  ────── または手動で入力 ──────       │
│                                     │
│  ウォレットアドレス                   │
│  [0x________________________]        │
│                                     │
│  ┌───────────────────────────┐      │
│  │ 現在のアドレス             │      │
│  │ 0xf60f...bfeb    [検証済み] │      │
│  │ 登録日: 2026-01-01 00:01   │      │
│  └───────────────────────────┘      │
│                                     │
│  [更新]  [削除]                      │
└─────────────────────────────────────┘
```

### 4.2 バッジ表示

| 状態 | 色 | 条件 |
|------|-----|------|
| 検証済み | 緑 | Metamask経由で接続 |
| 未検証 | 黄 | 手動入力 |

---

## 5. 依存関係

| パッケージ | 用途 |
|------------|------|
| ethers.js | Metamask接続（BrowserProvider） |

※ethers.jsは既存のJPYC投げ銭機能で導入済み

---

## 6. エラーハンドリング

| エラー | 表示メッセージ |
|--------|----------------|
| Metamask未インストール | `Metamaskがインストールされていません。https://metamask.io からインストールしてください。` |
| ユーザーキャンセル | `接続がキャンセルされました` |
| その他 | `接続中にエラーが発生しました` |

---

## 7. コミット履歴

| コミット | 内容 |
|----------|------|
| `026db5c` | feat: Metamask接続ボタン追加 |
| `51e3aba` | fix: Metamaskロゴを完全版に修正 |
| `c0ccdb0` | feat: Metamask接続時の自動検証と時間表示を日本時間に修正 |

---

## 8. テスト方法

1. https://mocca.sd-create.jp/profile/wallet にアクセス
2. 「Metamaskで接続」ボタンをクリック
3. Metamaskポップアップで接続を承認
4. アドレスがフォームに自動入力される
5. 「更新」ボタンで保存
6. 「検証済み」バッジと日本時間が表示されることを確認

---

## 9. 注意事項

1. **既存ウォレットの検証**
   - 既に登録済みのウォレットは「未検証」のまま
   - Metamaskで再接続すれば「検証済み」になる

2. **手動入力時の動作**
   - 手動で入力欄を編集すると`connected_via_metamask`がfalseにリセット
   - 保存時は「未検証」になる

3. **Window.ethereum型定義**
   - グローバル型定義ファイルで管理（`resources/js/types/`）
   - コンポーネント内でのローカル定義は避ける

---

## 10. 今後の拡張案

| 案 | 説明 |
|----|------|
| 署名検証 | メッセージ署名でより厳密な所有権証明 |
| ネットワーク検出 | Polygon以外のネットワーク時に警告表示 |
| 複数ウォレット | 1ユーザーが複数アドレスを登録 |

---

## 11. 関連ファイル

| ファイル | 内容 |
|----------|------|
| `app/Models/StaffWallet.php` | ウォレットモデル |
| `database/migrations/2025_12_29_070002_create_staff_wallets_table.php` | テーブル定義 |
| `resources/js/Pages/Profile/WalletCard.tsx` | QRコード表示ページ |

---

**引き継ぎ完了**
