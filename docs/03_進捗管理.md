# Moccaポータル 進捗管理

**最終更新:** 2025年12月29日 17:45 JST
**確認環境:** macOS Darwin 25.2.0 / Laravel 12.44.0 / MySQL 8.x
**ステージング環境:** https://mocca.sd-create.jp (デプロイ済み)

---

## 全体進捗

| Phase | 内容 | 状態 | 進捗 |
|-------|------|------|------|
| Phase 1 | コア基盤（認証・権限） | ✅ 完了 | 100% |
| Phase 2 | コア拡張 + 予約モジュール | ✅ 完了 | 100% |
| Phase C | JPYC投げ銭システム | ✅ 完了 | 100% |
| Phase 3 | チェックリストモジュール | ⬜ 未着手 | 0% |
| Phase 4 | 備品管理モジュール | ⬜ 未着手 | 0% |
| Phase 5 | タイムカードモジュール | ⬜ 未着手 | 0% |
| Phase 6 | お知らせモジュール | ⬜ 未着手 | 0% |
| Phase 7 | シフトモジュール | ⬜ 未着手 | 0% |
| Phase 8 | Googleカレンダー連携 | ⬜ 後回し | 0% |
| Phase 9 | 二要素認証 | ⬜ 後回し | 0% |

---

## Phase 1 詳細（完了）

### 完了確認方法
```bash
# マイグレーション確認
php artisan migrate:status
# → 0001_01_01_000000_create_users_table [1] Ran
# → 2025_12_29_041844_add_role_to_users_table [2] Ran

# usersテーブルスキーマ確認
mysql -u root mocca_portal -e "DESCRIBE users;"
# → role enum('admin','manager','staff') NO staff 確認済み

# Seederデータ確認
mysql -u root mocca_portal -e "SELECT id, name, email, role FROM users;"
# → admin@mocca-portal.local (admin)
# → manager@mocca-portal.local (manager)
# → staff@mocca-portal.local (staff)

# ミドルウェア存在確認
php artisan tinker --execute="echo class_exists(App\Http\Middleware\CheckRole::class);"
# → true
```

### タスク一覧

| タスク | 状態 | 確認方法 | 確認日時 |
|--------|------|----------|----------|
| Laravel Breezeインストール | ✅ | `composer show laravel/breeze` | 2025/12/29 13:00 |
| MySQL接続設定 | ✅ | `php artisan migrate` 成功 | 2025/12/29 13:10 |
| roleカラム追加 | ✅ | `DESCRIBE users;` で enum確認 | 2025/12/29 13:20 |
| Userモデルヘルパー | ✅ | `isAdmin()`, `isManager()` 等実装確認 | 2025/12/29 13:25 |
| CheckRoleミドルウェア | ✅ | `class_exists()` で確認 | 2025/12/29 13:30 |
| ミドルウェア登録 | ✅ | `bootstrap/app.php` で 'role' alias確認 | 2025/12/29 13:35 |
| AdminUserSeeder | ✅ | `SELECT * FROM users;` で3件確認 | 2025/12/29 13:40 |

---

## Phase 2 詳細（部分完了）

### 2.1 モジュールシステム基盤 ✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| config/modules.php作成 | ✅ | ファイル存在確認 |
| ModuleInterface作成 | ✅ | `class_exists()` 確認 |
| DashboardWidgetInterface作成 | ✅ | `class_exists()` 確認 |
| BaseModule作成 | ✅ | `class_exists()` 確認 |
| ModuleServiceProvider作成 | ✅ | `bootstrap/providers.php` 登録確認 |
| 各モジュールスケルトン | ✅ | 6モジュール作成、ルート登録確認 |

### 2.2 拠点マスター ✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| locationsマイグレーション | ✅ | `migrate:status` で確認 |
| Locationモデル | ✅ | `class_exists()` 確認 |
| LocationSeeder | ✅ | `SELECT * FROM locations;` → アジト/ばんしろう |

### 2.3 アクティビティログ ✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| activity_logsマイグレーション | ✅ | `migrate:status` で確認 |
| ActivityLogモデル | ✅ | `class_exists()` 確認 |
| ActivityLogService | ✅ | `class_exists()` 確認 |

### 2.4 ユーザー管理 ✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| user_invitationsマイグレーション | ✅ | テーブル作成済み |
| UserInvitationモデル | ✅ | 作成済み |
| Google OAuth認証 | ✅ | `composer show laravel/socialite` |
| google_idカラム追加 | ✅ | `migrate:status` 確認 |
| GoogleController | ✅ | `route:list --name=auth.google` |
| ユーザー管理画面 (Admin) | ✅ | `route:list --name=users` |
| スタッフ削除機能 | ✅ | UserController@destroy |
| 権限変更機能 | ✅ | UserController@updateRole |

### 2.5 ダッシュボード ✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| WidgetManager | ✅ | `class_exists()` 確認 |
| DashboardController | ✅ | `route:list --name=dashboard` |
| Dashboard.tsx更新 | ✅ | クイックアクション実装 |
| ユーザー管理リンク (Admin) | ✅ | Dashboard.tsx確認 |

### 2.6 予約モジュール（ばんしろう） ✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| banshirou_reservationsマイグレーション | ✅ | `migrate:status` 確認 |
| reservation_assignmentsマイグレーション | ✅ | `migrate:status` 確認 |
| BanshirouReservationモデル | ✅ | 作成済み |
| ReservationAssignmentモデル | ✅ | 作成済み |
| BanshirouReservationController | ✅ | `route:list --name=reservations.banshirou` |
| 予約一覧ページ (Index.tsx) | ✅ | ファイル存在確認 |
| ステップ形式入力フォーム (Create.tsx) | ✅ | 5ステップ実装 |
| 予約詳細ページ (Show.tsx) | ✅ | ファイル存在確認 |
| 予約編集ページ (Edit.tsx) | ✅ | ファイル存在確認 |

### 2.7 予約モジュール（もっか） ✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| mocca_reservationsマイグレーション | ✅ | `migrate:status` 確認 |
| MoccaReservationモデル | ✅ | 作成済み |
| MoccaReservationController | ✅ | `route:list --name=reservations.mocca` |
| 予約一覧ページ (Index.tsx) | ✅ | ファイル存在確認 |
| 予約作成ページ (Create.tsx) | ✅ | ファイル存在確認 |
| 予約詳細ページ (Show.tsx) | ✅ | ファイル存在確認 |
| 予約編集ページ (Edit.tsx) | ✅ | ファイル存在確認 |

### 2.8 担当割り当て ✅（部分実装）

| タスク | 状態 | 備考 |
|--------|------|------|
| AssignmentController | ✅ | 作成済み、アクティビティログ修正済み |
| 担当割り当てUI | ⬜ | Phase 3以降で実装 |
| リマインドメール通知 | ⬜ | Phase 3以降で実装 |

---

## 作成済みファイル一覧

### Phase 1
```
app/Models/User.php
app/Http/Middleware/CheckRole.php
bootstrap/app.php
database/migrations/2025_12_29_041844_add_role_to_users_table.php
database/seeders/AdminUserSeeder.php
database/seeders/DatabaseSeeder.php
resources/js/bootstrap.ts
```

### Phase 2
```
# ドキュメント
docs/01_システム仕様書.md
docs/02_実装計画書.md
docs/03_進捗管理.md

# 設定
config/modules.php
config/services.php（Google OAuth追加）

# コントラクト
app/Contracts/ModuleInterface.php
app/Contracts/DashboardWidgetInterface.php

# コア
app/Core/BaseModule.php
app/Services/ActivityLogService.php
app/Services/WidgetManager.php
app/Http/Controllers/DashboardController.php
app/Http/Controllers/UserController.php
app/Http/Controllers/Auth/GoogleController.php

# モデル
app/Models/Location.php
app/Models/ActivityLog.php
app/Models/UserInvitation.php
app/Modules/Reservation/Models/BanshirouReservation.php
app/Modules/Reservation/Models/ReservationAssignment.php
app/Modules/Reservation/Models/MoccaReservation.php

# コントローラー
app/Modules/Reservation/Controllers/BanshirouReservationController.php
app/Modules/Reservation/Controllers/MoccaReservationController.php
app/Modules/Reservation/Controllers/AssignmentController.php

# モジュール
app/Modules/Reservation/ReservationModule.php
app/Modules/Checklist/ChecklistModule.php
app/Modules/Inventory/InventoryModule.php
app/Modules/TimeCard/TimeCardModule.php
app/Modules/Announcement/AnnouncementModule.php
app/Modules/Shift/ShiftModule.php

# プロバイダ
app/Providers/ModuleServiceProvider.php
app/Providers/AppServiceProvider.php（更新）

# マイグレーション
database/migrations/2025_12_29_053424_create_locations_table.php
database/migrations/2025_12_29_053426_create_activity_logs_table.php
database/migrations/2025_12_29_053428_create_user_invitations_table.php
database/migrations/2025_12_29_053828_create_banshirou_reservations_table.php
database/migrations/2025_12_29_053828_create_reservation_assignments_table.php
database/migrations/2025_12_29_053828_create_mocca_reservations_table.php
database/migrations/2025_12_29_061506_add_google_id_to_users_table.php

# Seeder
database/seeders/LocationSeeder.php

# React - ばんしろう予約
resources/js/Pages/Dashboard.tsx（更新）
resources/js/Pages/Reservations/Banshirou/Index.tsx
resources/js/Pages/Reservations/Banshirou/Create.tsx
resources/js/Pages/Reservations/Banshirou/Show.tsx
resources/js/Pages/Reservations/Banshirou/Edit.tsx

# React - もっか予約
resources/js/Pages/Reservations/Mocca/Index.tsx
resources/js/Pages/Reservations/Mocca/Create.tsx
resources/js/Pages/Reservations/Mocca/Show.tsx
resources/js/Pages/Reservations/Mocca/Edit.tsx

# React - ユーザー管理
resources/js/Pages/Users/Index.tsx

# React - 認証
resources/js/Pages/Auth/Login.tsx（Google OAuth追加）

# 型定義
resources/js/types/index.d.ts（更新）

# ルート
routes/web.php（更新）
bootstrap/providers.php（更新）
```

---

## 次回作業開始時の手順

### 1. 環境確認
```bash
cd /Users/shoeigoto/Desktop/mocca-portal

# MySQLサービス確認
brew services list | grep mysql
# 停止している場合: brew services start mysql

# データベース確認
mysql -u root -e "SHOW DATABASES;" | grep mocca_portal
```

### 2. マイグレーション・シーダー確認
```bash
# マイグレーション状態確認
php artisan migrate:status

# 未適用がある場合は実行
php artisan migrate

# シーダー実行（初回またはリセット後）
php artisan db:seed
```

### 3. キャッシュクリア
```bash
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear
```

### 4. 開発サーバー起動
```bash
# Laravelサーバー
php artisan serve &

# Vite開発サーバー
npm run dev &
```

### 5. 動作確認
- http://localhost:8000 にアクセス
- ログイン: admin@mocca-portal.local / password
- ダッシュボードが表示されれば正常

### 6. Google OAuth設定（本番環境用）
```bash
# .envに以下を追加（値は別途管理）
GOOGLE_CLIENT_ID=<CLIENT_ID>
GOOGLE_CLIENT_SECRET=<CLIENT_SECRET>
GOOGLE_REDIRECT_URI=https://mocca.sd-create.jp/auth/google/callback
```

---

## データベース作成済みテーブル

| テーブル名 | 状態 | 確認コマンド |
|-----------|------|-------------|
| users | ✅ | `DESCRIBE users;` (google_id, avatar追加) |
| locations | ✅ | `SELECT * FROM locations;` |
| activity_logs | ✅ | `DESCRIBE activity_logs;` |
| user_invitations | ✅ | `DESCRIBE user_invitations;` |
| banshirou_reservations | ✅ | `DESCRIBE banshirou_reservations;` |
| reservation_assignments | ✅ | `DESCRIBE reservation_assignments;` |
| mocca_reservations | ✅ | `DESCRIBE mocca_reservations;` |

---

## テスト用アカウント

| メールアドレス | パスワード | ロール |
|---------------|-----------|--------|
| admin@mocca-portal.local | ※別途管理 | admin |
| manager@mocca-portal.local | ※別途管理 | manager |
| staff@mocca-portal.local | ※別途管理 | staff |

---

## 実行ログ（2025/12/29-30）

### マイグレーション実行結果
```
Migration name .............................................. Batch / Status
0001_01_01_000000_create_users_table ............................... [1] Ran
0001_01_01_000001_create_cache_table ............................... [1] Ran
0001_01_01_000002_create_jobs_table ................................ [1] Ran
2025_12_29_041844_add_role_to_users_table .......................... [2] Ran
2025_12_29_053424_create_locations_table ........................... [3] Ran
2025_12_29_053426_create_activity_logs_table ....................... [3] Ran
2025_12_29_053428_create_user_invitations_table .................... [3] Ran
2025_12_29_053828_create_banshirou_reservations_table .............. [4] Ran
2025_12_29_053828_create_mocca_reservations_table .................. [4] Ran
2025_12_29_053828_create_reservation_assignments_table ............. [4] Ran
2025_12_29_061506_add_google_id_to_users_table ..................... [5] Ran
```

### 2025/12/30 修正内容
- もっか予約Reactコンポーネント実装 (Index/Create/Show/Edit)
- ばんしろう予約Edit.tsx実装
- 予約ウィジェット参照エラー修正（空配列に変更）
- 担当割り当てアクティビティログ修正（created → assigned）
- Google OAuth認証実装
- ユーザー管理機能実装（Admin専用）
- スタッフ削除・権限変更機能実装
- ActivityLogService::log() 引数不一致バグ修正（8箇所）
- Tailwind動的クラス問題修正（静的マップに変更）

---

## 備考

### メールアドレス（任意）
電話予約時にメールアドレスを取得できない場合を考慮し、banshirou_reservations.emailはnullableで実装済み。バリデーションも任意として設定。

### 未実装モジュール
Phase 3以降で実装予定のモジュール（Checklist, Inventory, TimeCard, Announcement, Shift）は、コントローラーが未実装のためルート登録を無効化済み。実装時に`$this->registerRoutes()`のコメントを解除すること。

---

## Phase C 詳細（JPYC投げ銭システム）✅ 基盤完了（送金フロー未実装）

### 概要
ゲスト向けQRコードベースのJPYC暗号通貨投げ銭システム。詳細は`docs/04_追加機能仕様書_JPYC投げ銭.md`を参照。

### C.1 データベース（Phase A）✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| guest_pagesマイグレーション | ✅ | `migrate:status` 確認 |
| staff_walletsマイグレーション | ✅ | `migrate:status` 確認 |
| guest_staff_assignmentsマイグレーション | ✅ | `migrate:status` 確認 |
| tip_transactionsマイグレーション | ✅ | `migrate:status` 確認 |
| google_review_requestsマイグレーション | ✅ | `migrate:status` 確認 |

### C.2 バックエンド（Phase B）✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| GuestPageモデル | ✅ | `class_exists()` 確認 |
| StaffWalletモデル | ✅ | `class_exists()` 確認 |
| GuestStaffAssignmentモデル | ✅ | `class_exists()` 確認 |
| TipTransactionモデル | ✅ | `class_exists()` 確認 |
| GoogleReviewRequestモデル | ✅ | `class_exists()` 確認 |
| GuestPageController | ✅ | `route:list --name=guest` |
| GuestPageService | ✅ | QRコード生成ロジック |
| QrCodeService | ✅ | QRコード画像生成 |
| StaffWalletController | ✅ | ウォレット管理 |
| TipController (API) | ✅ | `/api/tip/*` エンドポイント |
| ReviewController (API) | ✅ | `/api/review/*` エンドポイント |
| TipStatisticsController (Admin) | ✅ | 管理者統計画面 |

### C.3 フロントエンド（Phase C）✅

| タスク | 状態 | 確認方法 |
|--------|------|----------|
| Guest/Show.tsx | ✅ | ゲスト向け投げ銭ページ |
| Guest/Expired.tsx | ✅ | 期限切れページ |
| Profile/Wallet.tsx | ✅ | スタッフウォレット設定 |
| Admin/StaffWallets.tsx | ✅ | 管理者ウォレット一覧 |
| Admin/TipStatistics.tsx | ✅ | 管理者統計ダッシュボード |
| Admin/StaffTipDetail.tsx | ✅ | スタッフ別詳細 |

### C.4 レビュー指摘修正 ✅

| 指摘内容 | 対応状態 |
|----------|----------|
| guest_pagesスキーマnullable修正 | ✅ 仕様書更新 |
| Google Place ID分岐 (mocca/banshirou) | ✅ 実装済み |
| TipController スタッフ割り当て検証 | ✅ 実装済み |
| ReviewController 有効期限チェック | ✅ 実装済み |
| canTip() guest_page_uuid必須化 | ✅ 実装済み |
| Google Review クリック記録 | ✅ 実装済み |
| ルート命名規則統一 | ✅ 仕様書更新 |

---

## ステージング環境デプロイ ✅ 完了

### サーバー情報

| 項目 | 値 |
|------|-----|
| URL | https://mocca.sd-create.jp |
| サーバーIP | ※別途管理 |
| Tailscale IP | ※別途管理 |
| ドキュメントルート | /var/www/mocca-portal |
| PHP | 8.2.29 (platform-check無効化) |
| データベース | MariaDB: mocca_portal |
| SSL | Let's Encrypt (2026-03-29まで有効) |

### デプロイ手順（実行済み）

```bash
# 1. サーバー接続 (Tailscale経由)
ssh root@<TAILSCALE_IP>

# 2. リポジトリclone
cd /var/www
git clone https://github.com/UKIYO-4s/mocca-portal.git

# 3. 依存関係インストール
cd mocca-portal
composer install --no-dev --ignore-platform-reqs --optimize-autoloader
npm install
npm run build

# 4. 環境設定
cp .env.example .env
php artisan key:generate
# .env編集（DB設定等）

# 5. パーミッション設定
chown -R www-data:www-data storage bootstrap/cache
chmod -R 775 storage bootstrap/cache

# 6. データベース作成
mysql -u root -e "CREATE DATABASE mocca_portal CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
mysql -u root -e "CREATE USER 'mocca'@'localhost' IDENTIFIED BY '<DB_PASSWORD>';"
mysql -u root -e "GRANT ALL PRIVILEGES ON mocca_portal.* TO 'mocca'@'localhost';"

# 7. マイグレーション
php artisan migrate --force
php artisan storage:link

# 8. キャッシュ最適化
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 9. nginx設定 (/etc/nginx/sites-available/mocca)
# 10. SSL証明書取得
certbot --nginx -d mocca.sd-create.jp
```

### nginx設定

```nginx
server {
    server_name mocca.sd-create.jp;
    root /var/www/mocca-portal/public;
    index index.php;
    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # SSL設定は certbot により自動追加
}
```

### 本番環境で必要な追加設定

| 項目 | .env変数 | 状態 |
|------|----------|------|
| Google OAuth | GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET | ✅ 設定済み |
| Google Place ID (ばんしろう) | GOOGLE_PLACE_ID_BANSHIROU | ⬜ 未設定 |
| Google Place ID (もっか) | GOOGLE_PLACE_ID_MOCCA | ⬜ 未設定 |
| LINE公式URL | LINE_OFFICIAL_URL | ⬜ 未設定 |
| 連絡先電話番号 | CONTACT_PHONE_NUMBER | ⬜ 未設定 |

### サーバー更新手順

```bash
# Tailscale経由でSSH接続
ssh root@<TAILSCALE_IP>

# コード更新
cd /var/www/mocca-portal
git pull origin main

# 依存関係更新（必要に応じて）
composer install --no-dev --ignore-platform-reqs --optimize-autoloader
npm install && npm run build

# マイグレーション（必要に応じて）
php artisan migrate --force

# キャッシュクリア
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

---

## 2025/12/29 作業ログ

### Phase C 実装
- JPYC投げ銭システム全機能実装
- データベース5テーブル追加
- API エンドポイント実装（tip, review）
- フロントエンド6ページ作成
- コードレビュー指摘対応完了

### TypeScript修正
- FormData型名衝突修正（ReservationFormData/MoccaFormDataにリネーム）
- インデックスシグネチャ追加
- handleCancel関数のペイロード修正

### ステージングデプロイ
- mocca.sd-create.jp へデプロイ完了
- SSL証明書取得（Let's Encrypt）
- MariaDBデータベース作成
- 全16テーブルマイグレーション実行

### コードレビュー対応（2回目）

#### 重大: 報告書と実装の不一致修正
- Phase C表記を「✅ 基盤完了（送金フローはPhase D） | 80%」に修正
- 投げ銭ボタンの送金フローは未実装（UIは「準備中」表示）

#### 重大: UI英語文言の日本語化
| ファイル | 修正箇所 |
|----------|----------|
| AuthenticatedLayout.tsx | Dashboard→ダッシュボード, Profile→プロフィール, Log Out→ログアウト |
| Auth/Login.tsx | Googleでログイン→グーグルでログイン |
| Guest/Show.tsx | Googleで口コミを書く→グーグルで口コミを書く, LINE→ライン |
| Profile/Wallet.tsx | Ethereum→イーサリアム, Polygon（MATIC）→ポリゴン（マティック） |
| Admin/TipStatistics.tsx | CSV出力→データ出力 |
| Welcome.tsx | ページ全体を日本語化（※Mocca Portalは例外で英語表記維持） |

#### 中: 報告書の機密情報伏字化
- サーバーIP、Tailscale IP → `※別途管理`
- DBパスワード → `<DB_PASSWORD>`
- OAuth認証情報 → `<CLIENT_ID>/<CLIENT_SECRET>`
- テスト用パスワード → `※別途管理`

#### その他
- Google OAuth設定状態を「✅ 設定済み」に修正

### コードレビュー対応（3回目）

#### 重大: プロフィール画面の英語文言を日本語化
| ファイル | 修正内容 |
|----------|----------|
| Profile/Edit.tsx | Profile→プロフィール |
| UpdateProfileInformationForm.tsx | Profile Information→プロフィール情報、Name→名前、Email→メールアドレス、Save→保存 等 |
| UpdatePasswordForm.tsx | Update Password→パスワード変更、Current Password→現在のパスワード、New Password→新しいパスワード 等 |
| DeleteUserForm.tsx | Delete Account→アカウント削除、Cancel→キャンセル、Password→パスワード 等 |
