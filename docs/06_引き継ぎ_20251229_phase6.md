# Mocca Portal 引き継ぎドキュメント

**作成日:** 2025年12月29日 22:30 JST
**作成者:** Claude Code (Opus 4.5)

---

## 1. プロジェクト概要

飲食店（もっか・ばんしろう）向けの業務管理ポータルシステム。

| 項目 | 値 |
|------|-----|
| フレームワーク | Laravel 12 + React + TypeScript + Inertia.js |
| DB | MySQL 8.x / MariaDB |
| 本番 | https://mocca.sd-create.jp |
| リポジトリ | https://github.com/UKIYO-4s/mocca-portal |

---

## 2. 完了済みPhase

| Phase | 内容 | 完了日 |
|-------|------|--------|
| Phase 1 | コア基盤（認証・権限） | 2025/12/29 |
| Phase 2 | コア拡張 + 予約モジュール | 2025/12/29 |
| Phase C | JPYC投げ銭システム | 2025/12/29 |
| Phase 3 | チェックリストモジュール | 2025/12/29 |
| Phase 4 | 備品管理モジュール | 2025/12/29 |
| Phase 5 | タイムカードモジュール | 2025/12/29 |
| Phase 6 | お知らせモジュール | 2025/12/29 |

---

## 3. 未着手Phase

| Phase | 内容 | 優先度 | 状態 |
|-------|------|--------|------|
| **Phase 7** | シフトモジュール | 中 | スケルトン作成済み |
| Phase 8 | Googleカレンダー連携 | 低 | 未着手 |
| Phase 9 | 二要素認証 | 低 | 未着手 |

---

## 4. 本日の実装内容（Phase 6 お知らせモジュール）

### 4.1 作成ファイル

```
app/Modules/Announcement/
├── Controllers/AnnouncementController.php  # 8メソッド
├── Models/
│   ├── Announcement.php                    # お知らせモデル
│   └── AnnouncementRead.php                # 既読管理モデル
└── AnnouncementModule.php                  # ルート定義

database/migrations/
└── 2025_12_29_131500_create_announcements_table.php

resources/js/Pages/Announcements/
├── Index.tsx    # 一覧（未読バッジ、下書きバッジ）
├── Show.tsx     # 詳細（自動既読）
├── Create.tsx   # 新規作成（Manager+）
└── Edit.tsx     # 編集（Manager+）
```

### 4.2 ルート一覧

| メソッド | パス | 機能 | 権限 |
|----------|------|------|------|
| GET | /announcements | 一覧 | 全員 |
| GET | /announcements/create | 作成画面 | Manager+ |
| POST | /announcements | 作成 | Manager+ |
| GET | /announcements/{announcement} | 詳細 | 全員 |
| GET | /announcements/{announcement}/edit | 編集画面 | Manager+ |
| PUT | /announcements/{announcement} | 更新 | Manager+ |
| DELETE | /announcements/{announcement} | 削除 | Manager+ |
| POST | /announcements/{announcement}/read | 既読 | 全員 |

### 4.3 データベース

**announcements**
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| title | varchar(255) | タイトル |
| content | text | 本文 |
| priority | enum | normal/important |
| published_at | timestamp | 公開日時（NULL=下書き） |
| created_by | bigint | FK → users |

**announcement_reads**
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| announcement_id | bigint | FK → announcements |
| user_id | bigint | FK → users |
| read_at | timestamp | 既読日時 |

### 4.4 コードレビュー対応履歴

| 指摘 | 重要度 | 対応 |
|------|--------|------|
| ルート順序で/createが到達不能 | 重大 | /createを{announcement}より先に定義 |
| 下書きが一覧に出ない | 中 | Manager+は全件表示、下書きバッジ追加 |
| N+1クエリ（is_read判定） | 低 | withExistsで一括判定、アクセサは事前ロード値を優先 |

### 4.5 機能仕様

| 機能 | Admin | Manager | Staff |
|------|:-----:|:-------:|:-----:|
| お知らせ閲覧 | ○ | ○ | ○ |
| 自動既読 | ○ | ○ | ○ |
| 作成/編集/削除 | ○ | ○ | × |
| 下書き閲覧 | ○ | ○ | × |

---

## 5. 開発環境

### 5.1 ローカル開発

```bash
composer dev  # または php artisan serve + npm run dev
npm run build
php artisan migrate
```

### 5.2 デプロイ

```bash
ssh root@100.103.127.122
cd /var/www/mocca-portal
git pull origin main
php artisan migrate --force
npm run build
php artisan config:cache
php artisan route:cache
```

### 5.3 テストアカウント

| メール | ロール |
|--------|--------|
| admin@mocca-portal.local | admin |
| manager@mocca-portal.local | manager |
| staff@mocca-portal.local | staff |

---

## 6. ディレクトリ構成

```
app/Modules/
├── Reservation/     # 予約 ✅
├── Checklist/       # チェックリスト ✅
├── Inventory/       # 備品管理 ✅
├── TimeCard/        # タイムカード ✅
├── Announcement/    # お知らせ ✅ ← 今回実装
└── Shift/           # シフト（スケルトン）

resources/js/Pages/
├── Reservations/
├── Checklists/
├── Inventory/
├── TimeCard/
└── Announcements/   # ← 今回作成
```

---

## 7. 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| CLAUDE.md | Claude Code向けガイド |
| docs/01_システム仕様書.md | 全体仕様・DB設計 |
| docs/05_引き継ぎ_20251229_phase5.md | Phase 5完了時点 |

---

## 8. 注意事項

1. **ルート順序の重要性**
   - `/create`などの固定パスは`{id}`パラメータより先に定義する
   - 今回の修正で学んだ教訓

2. **N+1対策パターン**
   - `withExists`でboolean属性を一括取得
   - モデルのアクセサは`$this->attributes`を先にチェック

3. **下書き機能**
   - `published_at`がNULLなら下書き
   - Manager+のみ一覧に表示

---

## 9. 次のアクション

1. Phase 7 シフトモジュール実装
2. 必要に応じて Phase 8, 9 を検討

---

## 10. Git情報

```
最新コミット: c718d7e
ブランチ: main
リモート: origin/main (up to date)
```

---

**引き継ぎ完了**
