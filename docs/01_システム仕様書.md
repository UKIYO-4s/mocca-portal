# Moccaポータル システム仕様書

**バージョン:** 2.0
**最終更新:** 2025年12月29日
**ステータス:** Phase 1 完了 / Phase 2 実装中

---

## 1. システム概要

### 1.1 目的
お食事処もっか（レストラン）と宿ばんしろう（宿泊施設）の業務を一元管理するスマートフォン対応ポータルシステム。

### 1.2 主な利用シーン
- 電話対応しながらの予約入力（会社スマホで通話、個人スマホでポータル操作）
- スタッフの日常業務チェック
- 備品の使用量記録と在庫管理
- 勤怠打刻

### 1.3 拠点
| ID | 名前 | 用途 |
|----|------|------|
| 1 | アジト | 寮・スタッフ関連 |
| 2 | ばんしろう | 宿泊施設 |

---

## 2. 技術スタック

| レイヤー | 技術 | バージョン |
|---------|------|-----------|
| Backend | Laravel | 12.x |
| Database | MySQL | 8.x |
| Frontend | React + TypeScript | 19.x |
| Routing | Inertia.js | - |
| CSS | Tailwind CSS | 4.x |
| 認証 | Laravel Breeze | - |
| Build | Vite | 6.x |

---

## 3. ユーザーと権限

### 3.1 ロール定義
| ロール | 説明 |
|--------|------|
| admin | 全機能へのアクセス、ユーザー管理、システム設定 |
| manager | ほとんどの機能へのアクセス、スタッフ管理 |
| staff | 基本的な業務機能のみ |

### 3.2 実運用の管理者
| 名前 | ロール |
|------|--------|
| 翔平 | Admin |
| まゆ | Admin |
| 英治 | Manager |

### 3.3 権限マトリクス

| 機能 | Admin | Manager | Staff |
|------|-------|---------|-------|
| **コア** ||||
| ユーザー招待 | ○ | ○ | × |
| ユーザー削除・権限変更 | ○ | × | × |
| 拠点管理 | ○ | × | × |
| アクティビティログ閲覧 | ○ | ○ | × |
| **予約** ||||
| 予約作成・編集 | ○ | ○ | ○ |
| 予約削除 | ○ | ○ | × |
| 担当者割り当て | ○ | ○ | × |
| **チェックリスト** ||||
| テンプレート編集 | ○ | ○ | × |
| チェック入力 | ○ | ○ | ○ |
| **備品管理** ||||
| 在庫数閲覧 | ○ | ○ | × |
| 在庫数変更（補充・調整） | ○ | ○ | × |
| 使用数量入力 | ○ | ○ | ○ |
| 発注点設定 | ○ | ○ | × |
| **タイムカード** ||||
| 自分の打刻 | ○ | ○ | ○ |
| 他人の勤怠修正 | ○ | ○ | × |
| 月次レポート | ○ | ○ | × |
| **お知らせ** ||||
| 投稿・編集 | ○ | ○ | × |
| 閲覧 | ○ | ○ | ○ |
| **シフト** ||||
| 作成・編集 | ○ | ○ | × |
| 閲覧 | ○ | ○ | ○ |

---

## 4. モジュール構成

### 4.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                      Moccaポータル                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    コア（Core）                      │   │
│  │  ・認証/権限  ・ユーザー管理  ・ダッシュボード      │   │
│  │  ・通知システム  ・アクティビティログ  ・設定管理   │   │
│  └─────────────────────────────────────────────────────┘   │
│                            ↓                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │ 予約管理 │ │チェック  │ │ 備品管理 │ │タイムカード│      │
│  │ Module   │ │リスト    │ │ Module   │ │ Module   │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │お知らせ  │ │ シフト   │ │ GCal     │ │  2FA     │      │
│  │ Module   │ │ Module   │ │ Module   │ │ Module   │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 モジュール一覧

| モジュール | 説明 | 初期状態 |
|-----------|------|----------|
| reservation | 予約管理（ばんしろう＋もっか） | 有効 |
| checklist | チェックリスト | 有効 |
| inventory | 備品管理 | 有効 |
| timecard | タイムカード | 有効 |
| announcement | お知らせ | 有効 |
| shift | シフト管理 | 有効 |
| google_calendar | Googleカレンダー連携 | 無効 |
| two_factor_auth | 二要素認証 | 無効 |

---

## 5. 機能詳細

### 5.1 予約管理（ばんしろう）

#### 入力フォーム（ステップ形式）
**Step 1: お客様情報**
- 名前（必須）
- フリガナ（必須）
- 電話番号（必須、自動ハイフン挿入、タップで発信可能）
- メールアドレス（任意）
- 住所（必須、郵便番号から自動入力）

**Step 2: 宿泊情報**
- チェックイン日（必須、カレンダー選択）
- チェックアウト日（必須、カレンダー選択）
- 大人人数（必須、+/-ボタン）
- 子供人数（+/-ボタン）

**Step 3: お食事・オプション**
- 食事オプション（食事付き/席のみ/食事なし）
- 送迎（あり/なし）
- その他オプション

**Step 4: お支払い・備考**
- 支払い方法（現金/カード/振込）
- 備考

**Step 5: 確認画面**

#### 担当者割り当て
- 掃除担当（cleaning）: チェックアウト日に部屋清掃
- セット担当（setup）: チェックイン日に準備作業

#### リマインドメール
- チェックイン前日: 掃除担当・セット担当に通知
- チェックアウト当日: 掃除担当に通知

### 5.2 予約管理（もっか）

- 予約タイプ: 朝食/昼食/夕食
- 予約日
- 名前
- 人数
- 到着時刻（任意）
- 電話番号（任意）
- 先出メニュー（任意）
- 備考
- ばんしろう予約との連携（任意）

### 5.3 チェックリスト

#### テンプレートタイプ
- lunch_prep: ランチ仕込み
- dinner_prep: ディナー仕込み
- cleaning: 掃除
- other: その他

#### 機能
- テンプレート管理（Manager以上）
- 日次チェックリスト生成
- チェック入力（全員）
- 完了ステータス管理

### 5.4 備品管理

#### 特徴
- **拠点別管理**: アジトとばんしろうで完全分離
- **権限別表示**:
  - Staff: 使用数量入力のみ（在庫数非表示）
  - Manager以上: 在庫数・履歴・レポート閲覧可能
- **発注点通知**: 在庫が閾値以下になるとManager以上に通知

#### 操作タイプ
- usage: 使用（マイナス）
- restock: 補充（プラス）
- adjustment: 調整（プラス/マイナス）

### 5.5 タイムカード

#### 機能
- 出勤/退勤打刻
- 休憩時間記録
- 勤務時間自動計算

#### 打刻忘れ対策
- アクティビティログから実働推定
- 管理者による修正機能（修正者・修正日時を記録）
- 月次レポート

### 5.6 お知らせ

- 投稿（Manager以上）
- 優先度（normal/important）
- 下書き保存
- 既読管理
- ダッシュボードウィジェット

### 5.7 シフト管理

- シフト作成・編集（Manager以上）
- カレンダー形式表示
- 拠点別フィルタ
- ダッシュボードウィジェット

### 5.8 ダッシュボード

#### スタッフ向け
- 今日の自分のタスク
- 今日の予約概要
- 未読のお知らせ
- 今週のシフト

#### Manager以上向け
- 上記＋在庫アラート
- 全体の予約状況
- チェックリスト完了状況

---

## 6. データベース設計

### 6.1 コアテーブル

#### users（既存）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| name | varchar(255) | 名前 |
| email | varchar(255) | メール（ユニーク） |
| role | enum | admin/manager/staff |
| password | varchar(255) | パスワード |
| remember_token | varchar(100) | - |
| email_verified_at | timestamp | - |
| created_at, updated_at | timestamp | - |

#### locations
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| name | varchar(255) | 拠点名 |
| slug | varchar(50) | URL用スラッグ（ユニーク） |
| is_active | boolean | 有効フラグ |
| created_at, updated_at | timestamp | - |

#### activity_logs
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| user_id | bigint | FK → users |
| module | varchar(50) | モジュール名 |
| action | varchar(100) | アクション名 |
| target_type | varchar(100) | 対象モデル |
| target_id | bigint | 対象ID |
| description | text | 説明 |
| ip_address | varchar(45) | IPアドレス |
| user_agent | text | ユーザーエージェント |
| created_at | timestamp | - |

#### user_invitations
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| email | varchar(255) | 招待メール |
| token | varchar(64) | 招待トークン（ユニーク） |
| invited_by | bigint | FK → users |
| expires_at | timestamp | 有効期限 |
| accepted_at | timestamp | 受諾日時 |
| created_at | timestamp | - |

### 6.2 予約モジュール

#### banshirou_reservations
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| name | varchar(255) | 名前 |
| name_kana | varchar(255) | フリガナ |
| phone | varchar(20) | 電話番号 |
| email | varchar(255) | メール（任意） |
| address | text | 住所 |
| checkin_date | date | チェックイン日 |
| checkout_date | date | チェックアウト日 |
| guest_count_adults | int | 大人人数 |
| guest_count_children | int | 子供人数 |
| meal_option | enum | with_meals/seat_only/no_meals |
| pickup_required | boolean | 送迎有無 |
| options | json | オプション |
| payment_method | enum | cash/credit/bank_transfer |
| notes | text | 備考 |
| created_by | bigint | FK → users |
| status | enum | confirmed/cancelled |
| created_at, updated_at | timestamp | - |

#### reservation_assignments
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| reservation_id | bigint | FK → banshirou_reservations |
| assignment_type | enum | cleaning/setup |
| user_id | bigint | FK → users |
| reminder_sent_day_before | boolean | 前日リマインド送信済み |
| reminder_sent_day_of | boolean | 当日リマインド送信済み |
| created_at, updated_at | timestamp | - |

#### mocca_reservations
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| reservation_type | enum | breakfast/lunch/dinner |
| reservation_date | date | 予約日 |
| name | varchar(255) | 名前 |
| guest_count | int | 人数 |
| arrival_time | time | 到着時刻 |
| phone | varchar(20) | 電話番号 |
| advance_menu | text | 先出メニュー |
| notes | text | 備考 |
| banshirou_reservation_id | bigint | FK → banshirou_reservations |
| created_by | bigint | FK → users |
| status | enum | confirmed/cancelled |
| created_at, updated_at | timestamp | - |

### 6.3 チェックリストモジュール

#### checklist_templates
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| name | varchar(255) | テンプレート名 |
| type | enum | lunch_prep/dinner_prep/cleaning/other |
| location_id | bigint | FK → locations（NULL=全拠点共通） |
| is_active | boolean | 有効フラグ |
| sort_order | int | 表示順 |
| created_at, updated_at | timestamp | - |

#### checklist_items
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| template_id | bigint | FK → checklist_templates |
| description | varchar(500) | 項目説明 |
| sort_order | int | 表示順 |
| created_at, updated_at | timestamp | - |

#### daily_checklists
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| template_id | bigint | FK → checklist_templates |
| date | date | 日付 |
| created_by | bigint | FK → users |
| completed_at | timestamp | 完了日時 |
| created_at, updated_at | timestamp | - |

#### daily_checklist_entries
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| daily_checklist_id | bigint | FK → daily_checklists |
| checklist_item_id | bigint | FK → checklist_items |
| completed_at | timestamp | 完了日時 |
| completed_by | bigint | FK → users |

### 6.4 備品管理モジュール

#### inventory_items
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| location_id | bigint | FK → locations |
| name | varchar(255) | 品目名 |
| unit | varchar(50) | 単位（枚、個、本など） |
| current_stock | int | 現在在庫数 |
| reorder_point | int | 発注点 |
| reorder_notified_at | timestamp | 発注通知送信日時 |
| is_active | boolean | 有効フラグ |
| created_at, updated_at | timestamp | - |

#### inventory_logs
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| item_id | bigint | FK → inventory_items |
| type | enum | usage/restock/adjustment |
| quantity_change | int | 数量変動 |
| notes | text | 備考 |
| user_id | bigint | FK → users |
| created_at | timestamp | - |

### 6.5 タイムカードモジュール

#### time_records
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| user_id | bigint | FK → users |
| date | date | 日付 |
| clock_in | timestamp | 出勤時刻 |
| clock_out | timestamp | 退勤時刻 |
| break_minutes | int | 休憩時間（分） |
| notes | text | 備考 |
| modified_by | bigint | FK → users（修正者） |
| modified_at | timestamp | 修正日時 |
| created_at, updated_at | timestamp | - |

### 6.6 お知らせモジュール

#### announcements
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| title | varchar(255) | タイトル |
| content | text | 本文 |
| priority | enum | normal/important |
| published_at | timestamp | 公開日時（NULL=下書き） |
| created_by | bigint | FK → users |
| created_at, updated_at | timestamp | - |

#### announcement_reads
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| announcement_id | bigint | FK → announcements |
| user_id | bigint | FK → users |
| read_at | timestamp | 既読日時 |

### 6.7 シフトモジュール

#### shifts
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| user_id | bigint | FK → users |
| date | date | 日付 |
| start_time | time | 開始時刻 |
| end_time | time | 終了時刻 |
| location_id | bigint | FK → locations |
| notes | text | 備考 |
| created_by | bigint | FK → users |
| created_at, updated_at | timestamp | - |

---

## 7. セキュリティ設定

| 項目 | 設定値 |
|------|--------|
| セッションタイムアウト | 24時間 |
| パスワード最低文字数 | 8文字 |
| ログイン試行制限 | 5回失敗で15分ロック |
| 招待制登録 | 有効（誰でも登録不可） |
| HTTPS強制 | 本番環境で有効 |
| 新デバイスログイン通知 | メールで通知 |
| パスワード変更通知 | メールで通知 |
| 操作ログ | アクティビティログで記録 |
| CSRF対策 | Laravel標準 |
| SQLインジェクション対策 | Eloquent ORM |
| XSS対策 | React + Blade |

---

## 8. UI/UX方針

### 8.1 基本原則
- **スマホファースト**: 電話対応しながら片手で操作可能
- **大きなタップターゲット**: 44px以上
- **ステップフォーム**: 長いフォームは段階的に
- **クイックアクション**: 1タップでアクセス

### 8.2 入力補助
- 日付: カレンダーから選択
- 人数: +/- ボタン
- 電話番号: 自動ハイフン挿入
- 電話番号: タップで発信（tel:リンク）
- 住所: 郵便番号から自動入力
- メールアドレス: 任意

---

## 9. ディレクトリ構造

```
app/
├── Contracts/                     # インターフェース定義
│   ├── ModuleInterface.php
│   ├── NotifiableInterface.php
│   └── DashboardWidgetInterface.php
│
├── Core/                          # コア機能（常に有効）
│   ├── Auth/
│   ├── User/
│   ├── Dashboard/
│   ├── Notification/
│   ├── ActivityLog/
│   └── Location/
│
├── Modules/                       # 機能モジュール（ON/OFF可能）
│   ├── Reservation/
│   ├── Checklist/
│   ├── Inventory/
│   ├── TimeCard/
│   ├── Announcement/
│   └── Shift/
│
└── Providers/
    └── ModuleServiceProvider.php

config/
└── modules.php                    # モジュール有効/無効設定
```

---

## 10. 完了状況

### Phase 1: コア基盤 ✅ 完了
- [x] Laravel Breeze (Inertia + React + TypeScript)
- [x] Tailwind CSS
- [x] MySQL接続
- [x] 権限カラム（admin/manager/staff）
- [x] CheckRoleミドルウェア
- [x] 初期ユーザーSeeder

### Phase 2: コア拡張 + 予約モジュール ⏳ 実装中
- [ ] モジュールシステム基盤
- [ ] ダッシュボードウィジェットシステム
- [ ] 拠点マスター
- [ ] 通知システム
- [ ] アクティビティログ
- [ ] 予約モジュール（ばんしろう）
- [ ] 予約モジュール（もっか）
- [ ] 担当割り当て機能

### Phase 3以降
- チェックリストモジュール
- 備品管理モジュール
- タイムカードモジュール
- お知らせモジュール
- シフトモジュール
- Googleカレンダー連携（後で）
- 二要素認証（後で）
