# 引き継ぎ文書 - 2025年12月30日 12:30

## 完了した作業

### 1. 招待リンク運用改善

**コミット:** `2421d2f` - `feat: 招待リンク運用改善 + プロフィール写真機能`

#### 変更内容
| 変更 | 詳細 |
|------|------|
| `invitee_name` 追加 | 招待者名を必須フィールドとして追加 |
| `email` 任意化 | メールアドレスを任意に変更（登録時に入力も可） |
| URLコピーモーダル | 招待作成後にURLコピーモーダルを表示 |
| 登録画面改善 | 「○○さんの招待」ヘッダー表示、名前を初期値にセット |

#### 変更ファイル
```
database/migrations/2025_12_30_030348_update_invites_add_invitee_name.php (新規)
app/Models/Invite.php
app/Http/Controllers/Admin/InvitesController.php
app/Http/Controllers/Auth/InviteController.php
resources/js/Pages/Admin/Invites/Index.tsx
resources/js/Pages/Auth/InviteRegister.tsx
```

### 2. プロフィール写真機能

#### 変更内容
| 変更 | 詳細 |
|------|------|
| 写真アップロード | プロフィール編集画面から写真をアップロード可能に |
| Google OAuth対応 | 既存のGoogle OAuth URLとローカルファイル両方に対応 |
| ゲストページ連携 | スタッフ写真をゲストページに表示 |

#### 変更ファイル
```
resources/js/Pages/Profile/Partials/UpdateAvatarForm.tsx (新規)
app/Models/User.php (getAvatarUrlAttribute アクセサ追加)
app/Models/GuestPage.php (avatar_url 使用に変更)
app/Http/Controllers/ProfileController.php (updateAvatar, destroyAvatar 追加)
routes/web.php (アバタールート追加)
resources/js/Pages/Profile/Edit.tsx
```

---

## 未対応の不具合（最優先）

### 入力時にフォーカスが外れる（新規予約・ステップ入力）

**症状:**
- 予約フォームで1文字入力すると入力欄がフォーカスアウトする

**想定原因:**
- 入力ごとにコンポーネントが再マウントしている
  - `key` の付け方（`key={step}`, `key={inputMode}` など）
  - `useEffect` や `setState` によるフォーム全体の再生成

**修正対象ファイル:**
- `resources/js/Pages/Reservations/Banshirou/Create.tsx`
  - Step 1 フォーム
  - Single モード

**調査ポイント:**
1. 入力フォームに `key` を付け替えていないか確認
   - `key={step}` や `key={inputMode}` がある場合は削除
2. `getDefaultMode()` の `useEffect` が入力時に再走していないか確認
   - 依存関係を `[]` に固定
   - `inputMode` を入力中に再設定しない
3. `setFormData` で `initialFormData` へ戻していないか確認
   - `updateField()` で `setFormData(prev => ...)` を使用
   - `setFormData(initialFormData)` の誤呼び出しがないか

**修正完了後の確認:**
- 文字入力でフォーカスが外れないこと
- ステップ遷移やモード切替後も連続入力できること

---

## 本番環境状態

| 項目 | 状態 |
|------|------|
| 最新コミット | `2421d2f` デプロイ済み |
| マイグレーション | 実行済み |
| ビルド | 成功 |
| storage:link | 設定済み |

**本番URL:** https://mocca-portal.ukiyo-4s.com

---

## 直近のコミット履歴

```
2421d2f feat: 招待リンク運用改善 + プロフィール写真機能
d668fde feat: マイウォレットページ追加 - QRコード付きウォレット表示
9b663a9 fix: 投げ銭統計をAdmin専用に戻し、JPYCリンクを追加
4c62994 feat: 投げ銭統計の権限を全認証ユーザーに開放
```

---

## 次のアクション

1. **最優先:** フォーカス喪失バグの修正
   - `Banshirou/Create.tsx` の調査・修正
   - 修正後のテスト

2. テスト指示書（`docs/05_テスト指示書.md`）に基づく動作確認
