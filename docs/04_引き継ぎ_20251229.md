# Mocca Portal 引き継ぎドキュメント

**作成日:** 2025年12月29日 20:50 JST
**最終更新:** 2025年12月29日 23:40 JST
**作成者:** Claude Code (Opus 4.5)

---

## 1. プロジェクト概要

飲食店（もっか・ばんしろう）向けの業務管理ポータルシステム。

| 項目 | 値 |
|------|-----|
| フレームワーク | Laravel 12 + React + TypeScript + Inertia.js |
| DB | MySQL 8.x / MariaDB |
| ステージング | https://mocca.sd-create.jp |
| リポジトリ | https://github.com/UKIYO-4s/mocca-portal |

---

## 2. 完了済みPhase

| Phase | 内容 | 完了日 |
|-------|------|--------|
| Phase 1 | コア基盤（認証・権限） | 2025/12/29 |
| Phase 2 | コア拡張 + 予約モジュール | 2025/12/29 |
| Phase C | JPYC投げ銭システム | 2025/12/29 |
| Phase 3 | チェックリストモジュール | 2025/12/29 |
| Phase 4 | 備品管理モジュール | 2025/12/29 |
| Phase 5 | タイムカードモジュール | 2025/12/29 |
| Phase 6 | お知らせモジュール | 2025/12/29 |
| Phase 7 | シフト管理モジュール | 2025/12/29 |

---

## 3. 未着手Phase

| Phase | 内容 | 優先度 | 備考 |
|-------|------|--------|------|
| Phase 8 | Googleカレンダー連携 | 低 | 後回し |
| Phase 9 | 二要素認証 | 低 | 後回し |

---

## 4. Phase 4 備品管理モジュール

### 4.1 作成ファイル

```
app/Modules/Inventory/
├── Controllers/InventoryController.php  # 11メソッド
├── Models/
│   ├── InventoryItem.php                # 備品マスター
│   └── InventoryLog.php                 # 操作履歴
└── InventoryModule.php                  # ルート定義

database/migrations/
├── 2025_12_29_110226_create_inventory_items_table.php
└── 2025_12_29_110226_create_inventory_logs_table.php

resources/js/Pages/Inventory/
├── Index.tsx    # スタッフ用使用入力（在庫数非表示）
├── Manage.tsx   # 管理者用一覧
├── Create.tsx   # 新規登録
├── Edit.tsx     # 編集 + 補充/調整モーダル
└── Logs.tsx     # 操作履歴
```

### 4.2 コードレビュー対応履歴

| 指摘 | 対応 |
|------|------|
| ルート名不一致 (inventory.items.* → inventory.*) | 修正済み |
| destroy未実装 | 実装済み |
| 使用記録形式（単件→複数件対応） | 修正済み |
| logs paginate → get | 修正済み |
| notes/item_id フィールド名不一致 | 修正済み |
| 補充/調整ボタン405エラー | 修正済み（Edit画面へ遷移+モーダル自動表示） |
| logDeleted引数不足 | 修正済み |

---

## 5. Phase 5 タイムカードモジュール

### 5.1 機能

| 機能 | Admin | Manager | Staff |
|------|:-----:|:-------:|:-----:|
| 自分の打刻（出勤/退勤） | ○ | ○ | ○ |
| 自分の履歴閲覧 | ○ | ○ | ○ |
| 他人の勤怠修正 | ○ | ○ | × |
| 月次レポート | ○ | ○ | × |

### 5.2 データベース（time_records）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| user_id | bigint | FK → users |
| date | date | 日付 |
| clock_in | timestamp | 出勤時刻 |
| clock_out | timestamp | 退勤時刻 |
| break_minutes | int | 休憩時間（分） |
| notes | text | 備考 |
| modified_by | bigint | FK → users（修正者） |
| modified_at | timestamp | 修正日時 |

### 5.3 画面

| 画面 | 対象 | 機能 |
|------|------|------|
| Index.tsx | 全員 | 打刻画面（出勤/退勤ボタン） |
| History.tsx | 全員 | 自分の勤務履歴 |
| Manage.tsx | Manager+ | 全スタッフ勤怠一覧・修正 |
| Reports.tsx | Manager+ | 月次レポート |

---

## 6. Phase 6 お知らせモジュール

### 6.1 機能

| 機能 | Admin | Manager | Staff |
|------|:-----:|:-------:|:-----:|
| お知らせ閲覧 | ○ | ○ | ○ |
| 既読管理 | ○ | ○ | ○ |
| お知らせ作成/編集/削除 | ○ | ○ | × |
| 下書き管理 | ○ | ○ | × |

### 6.2 データベース

**announcements テーブル**
| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| title | varchar(255) | タイトル |
| content | text | 本文 |
| priority | enum | 優先度（low/normal/high/urgent） |
| is_published | boolean | 公開フラグ |
| published_at | timestamp | 公開日時 |
| created_by | bigint | FK → users |

**announcement_reads テーブル**
| カラム | 型 | 説明 |
|--------|-----|------|
| announcement_id | bigint | FK → announcements |
| user_id | bigint | FK → users |
| read_at | timestamp | 既読日時 |

### 6.3 画面

| 画面 | 対象 | 機能 |
|------|------|------|
| Index.tsx | 全員 | お知らせ一覧（既読/未読表示） |
| Show.tsx | 全員 | 詳細表示（自動既読処理） |
| Create.tsx | Manager+ | 新規作成 |
| Edit.tsx | Manager+ | 編集 |

---

## 7. Phase 7 シフト管理モジュール

### 7.1 機能

| 機能 | Admin | Manager | Staff |
|------|:-----:|:-------:|:-----:|
| 週間シフト表示 | ○ | ○ | ○ |
| 月間カレンダー表示 | ○ | ○ | ○ |
| マイシフト表示 | ○ | ○ | ○ |
| シフト作成/編集/削除 | ○ | ○ | × |

### 7.2 データベース（shifts）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| user_id | bigint | FK → users |
| location_id | bigint | FK → locations (nullable) |
| date | date | シフト日 |
| start_time | time | 開始時刻 |
| end_time | time | 終了時刻 |
| notes | text | 備考 |
| created_by | bigint | FK → users |

**ユニーク制約**: user_id + date + start_time

### 7.3 バリデーションルール

| ルール | 説明 |
|--------|------|
| 重複禁止 | 同一ユーザー/同一日の時間帯重複を禁止 |
| 日跨ぎ禁止 | end_time > start_time 必須 |
| 排他制御 | DB::transaction + lockForUpdate |

### 7.4 画面

| 画面 | 対象 | 機能 |
|------|------|------|
| Index.tsx | 全員 | 週間シフト表（ISO週/月曜始まり） |
| Calendar.tsx | 全員 | 月間カレンダー |
| My.tsx | 全員 | 自分のシフト一覧 |
| Manage.tsx | Manager+ | シフト管理（CRUD） |

### 7.5 作成ファイル

```
app/Modules/Shift/
├── Controllers/ShiftController.php  # 8メソッド
├── Models/Shift.php                 # スコープ、重複チェック
└── ShiftModule.php                  # ルート定義

database/migrations/
└── 2025_12_29_142000_create_shifts_table.php

resources/js/Pages/Shifts/
├── Index.tsx    # 週間表示（ユーザー×曜日グリッド）
├── Calendar.tsx # 月間カレンダー
├── My.tsx       # マイシフト
└── Manage.tsx   # 管理画面（モーダルフォーム）
```

### 7.6 コードレビュー対応履歴

| 重要度 | 指摘 | 対応 |
|--------|------|------|
| 重大 | Model の日跨ぎ計算が仕様と矛盾 | end <= start は無効データとして0/false返却 |
| 中 | Calendar.tsx の props 不一致 | 未使用の monthStart/monthEnd を削除 |
| 中 | 同時リクエストで重複が抜ける | DB::transaction + lockForUpdate 追加 |

---

## 8. 開発環境

### 8.1 ローカル開発

```bash
# サーバー起動
php artisan serve
npm run dev

# ビルド
npm run build

# マイグレーション
php artisan migrate
```

### 8.2 デプロイ

```bash
# SSH接続
ssh root@100.103.127.122

# デプロイコマンド
cd /var/www/mocca-portal
git pull origin main
php artisan migrate --force
npm run build
php artisan config:cache
php artisan route:cache
```

### 8.3 テストアカウント

| メール | ロール |
|--------|--------|
| admin@mocca-portal.local | admin |
| manager@mocca-portal.local | manager |
| staff@mocca-portal.local | staff |

---

## 9. ディレクトリ構成

```
app/
├── Contracts/                    # インターフェース
├── Core/                         # コア機能
│   ├── BaseModule.php
│   └── ActivityLog/
├── Modules/                      # 機能モジュール
│   ├── Reservation/              # 予約（ばんしろう/もっか）
│   ├── Checklist/                # チェックリスト
│   ├── Inventory/                # 備品管理 ✅ 完了
│   ├── TimeCard/                 # タイムカード ✅ 完了
│   ├── Announcement/             # お知らせ ✅ 完了
│   └── Shift/                    # シフト ✅ 完了
└── Services/
    └── ActivityLogService.php

resources/js/
├── Components/                   # 共通コンポーネント
├── Layouts/
│   └── AuthenticatedLayout.tsx   # ナビゲーション
├── Pages/
│   ├── Reservations/             # 予約画面
│   ├── Checklists/               # チェックリスト画面
│   ├── Inventory/                # 備品管理画面 ✅ 完了
│   ├── TimeCard/                 # タイムカード画面 ✅ 完了
│   ├── Announcements/            # お知らせ画面 ✅ 完了
│   ├── Shifts/                   # シフト画面 ✅ 完了
│   └── ...
└── types/
    └── index.d.ts                # TypeScript型定義
```

---

## 10. 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| docs/01_システム仕様書.md | 全体仕様・DB設計 |
| docs/02_実装計画書.md | 実装手順・コード例 |
| docs/03_進捗管理.md | 進捗・実行ログ |

---

## 11. 注意事項

1. **モジュールパターン**
   - 各モジュールは `BaseModule` を継承
   - `boot()` でルート登録、コメントアウト解除で有効化

2. **コードレビュー観点**
   - Inertiaパスと実ファイルの一致
   - ルート名の一致
   - Props名の一致（Controller ↔ React）
   - paginate() vs get()（フロントが配列前提の場合）
   - フィールド名の一致（DB ↔ Model ↔ TypeScript）

3. **デプロイ時**
   - `php artisan migrate --force` を忘れずに
   - `npm run build` でフロントエンドビルド
   - キャッシュクリア/再生成

---

## 12. 次のアクション

1. Phase 8 Googleカレンダー連携の検討
2. Phase 9 二要素認証の検討
3. 各モジュールのユーザーフィードバック収集・改善

---

**引き継ぎ完了**
