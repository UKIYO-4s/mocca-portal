# Mocca Portal 完了済み引き継ぎアーカイブ

**作成日:** 2026年1月3日
**目的:** 過去の引き継ぎドキュメントの統合アーカイブ

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [完了済みPhase一覧](#2-完了済みphase一覧)
3. [Phase別実装詳細](#3-phase別実装詳細)
4. [コードレビュー対応履歴](#4-コードレビュー対応履歴)
5. [機能追加・改善履歴](#5-機能追加改善履歴)
6. [バグ修正履歴](#6-バグ修正履歴)

---

## 1. プロジェクト概要

飲食店（もっか・ばんしろう）向けの業務管理ポータルシステム。

| 項目 | 値 |
|------|-----|
| フレームワーク | Laravel 12 + React + TypeScript + Inertia.js |
| DB | MySQL 8.x / MariaDB |
| 本番 | https://mocca.sd-create.jp |
| ステージング | https://mocca.sd-create.jp |
| リポジトリ | https://github.com/UKIYO-4s/mocca-portal |

### テストアカウント

| メール | ロール |
|--------|--------|
| admin@mocca-portal.local | admin |
| manager@mocca-portal.local | manager |
| staff@mocca-portal.local | staff |

### デプロイ手順

```bash
ssh root@100.103.127.122
cd /var/www/mocca-portal
git pull origin main
php artisan migrate --force
npm run build
php artisan config:cache
php artisan route:cache
```

---

## 2. 完了済みPhase一覧

| Phase | 内容 | 完了日 | 状態 |
|-------|------|--------|------|
| Phase 1 | コア基盤（認証・権限） | 2025/12/29 | 完了 |
| Phase 2 | コア拡張 + 予約モジュール | 2025/12/29 | 完了 |
| Phase C | JPYC投げ銭システム | 2025/12/29 | 完了 |
| Phase 3 | チェックリストモジュール | 2025/12/29 | 完了 |
| Phase 4 | 備品管理モジュール | 2025/12/29 | 完了 |
| Phase 5 | タイムカードモジュール | 2025/12/29 | 完了 |
| Phase 6 | お知らせモジュール | 2025/12/29 | 完了 |
| Phase 7 | シフト管理モジュール | 2025/12/29 | 完了 |
| Phase 8 | Googleカレンダー連携 | - | **クライアント承認待ち** (別途 `10_未実装_外部予約連携.md` 参照) |
| Phase 9 | 二要素認証(TOTP) | 2025/12/30 | 完了 |

---

## 3. Phase別実装詳細

### 3.1 Phase 4: 備品管理モジュール

**作成ファイル:**
```
app/Modules/Inventory/
├── Controllers/InventoryController.php  # 11メソッド
├── Models/
│   ├── InventoryItem.php                # 備品マスター
│   └── InventoryLog.php                 # 操作履歴
└── InventoryModule.php                  # ルート定義

resources/js/Pages/Inventory/
├── Index.tsx    # スタッフ用使用入力（在庫数非表示）
├── Manage.tsx   # 管理者用一覧
├── Create.tsx   # 新規登録
├── Edit.tsx     # 編集 + 補充/調整モーダル
└── Logs.tsx     # 操作履歴
```

---

### 3.2 Phase 5: タイムカードモジュール

**作成ファイル:**
```
app/Modules/TimeCard/
├── Controllers/TimeCardController.php  # 10メソッド
├── Models/TimeRecord.php               # 勤怠レコード
└── TimeCardModule.php                  # ルート定義

resources/js/Pages/TimeCard/
├── Index.tsx     # 打刻画面（出勤/休憩/退勤ボタン）
├── History.tsx   # 自分の勤務履歴
├── Manage.tsx    # 管理者用一覧・修正
└── Reports.tsx   # 月次レポート
```

**データベース（time_records）:**

| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| user_id | bigint | FK → users |
| date | date | 日付（ユニーク制約: user_id + date） |
| clock_in | timestamp | 出勤時刻 |
| clock_out | timestamp | 退勤時刻 |
| break_start | timestamp | 休憩開始時刻 |
| break_end | timestamp | 休憩終了時刻 |
| break_minutes | int | 休憩時間（分） |
| notes | text | 備考 |
| modified_by | bigint | FK → users（修正者） |
| modified_at | timestamp | 修正日時 |

**仕様決定事項:**
- 休憩入力方法: ボタン式（休憩開始/休憩終了）
- 打刻制限: 1日1回のみ
- 休憩制限: 1日1回のみ

---

### 3.3 Phase 6: お知らせモジュール

**作成ファイル:**
```
app/Modules/Announcement/
├── Controllers/AnnouncementController.php  # 8メソッド
├── Models/
│   ├── Announcement.php                    # お知らせモデル
│   └── AnnouncementRead.php                # 既読管理モデル
└── AnnouncementModule.php                  # ルート定義

resources/js/Pages/Announcements/
├── Index.tsx    # 一覧（未読バッジ、下書きバッジ）
├── Show.tsx     # 詳細（自動既読）
├── Create.tsx   # 新規作成（Manager+）
└── Edit.tsx     # 編集（Manager+）
```

**権限:**

| 機能 | Admin | Manager | Staff |
|------|:-----:|:-------:|:-----:|
| お知らせ閲覧 | ○ | ○ | ○ |
| 自動既読 | ○ | ○ | ○ |
| 作成/編集/削除 | ○ | ○ | × |
| 下書き閲覧 | ○ | ○ | × |

---

### 3.4 Phase 7: シフト管理モジュール

**作成ファイル:**
```
app/Modules/Shift/
├── Controllers/ShiftController.php  # 8メソッド
├── Models/Shift.php                 # スコープ、重複チェック
└── ShiftModule.php                  # ルート定義

resources/js/Pages/Shifts/
├── Index.tsx    # 週間表示（ユーザー×曜日グリッド）
├── Calendar.tsx # 月間カレンダー
├── My.tsx       # マイシフト
└── Manage.tsx   # 管理画面（モーダルフォーム）
```

**データベース（shifts）:**

| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| user_id | bigint | FK → users |
| location_id | bigint | FK → locations (nullable) |
| date | date | シフト日 |
| start_time | time | 開始時刻 |
| end_time | time | 終了時刻 |
| notes | text | 備考 |
| created_by | bigint | FK → users |

**バリデーションルール:**
- 重複禁止: 同一ユーザー/同一日の時間帯重複を禁止
- 日跨ぎ禁止: end_time > start_time 必須
- 排他制御: DB::transaction + lockForUpdate

---

### 3.5 Phase 9: 二要素認証(TOTP)

**作成ファイル:**
```
app/Http/Controllers/Auth/
└── TwoFactorController.php    # 設定・有効化・無効化・検証

app/Http/Middleware/
└── EnsureTwoFactorAuthenticated.php  # 2FA未確認ユーザーをリダイレクト

resources/js/Pages/Auth/TwoFactor/
├── Setup.tsx      # 設定画面（QRコード・リカバリーコード表示）
└── Challenge.tsx  # ログイン時認証画面
```

**技術詳細:**

| 項目 | 内容 |
|------|------|
| QRコード生成 | BaconQrCode（サーバーサイドSVG生成） |
| TOTPライブラリ | pragmarx/google2fa |
| シークレット保存 | Laravel encrypt()で暗号化 |
| セッション管理 | `two_factor_confirmed` フラグでセッション内確認済み判定 |

---

## 4. コードレビュー対応履歴

### Phase 4 備品管理

| 指摘 | 対応 |
|------|------|
| ルート名不一致 (inventory.items.* → inventory.*) | 修正済み |
| destroy未実装 | 実装済み |
| 使用記録形式（単件→複数件対応） | 修正済み |
| logs paginate → get | 修正済み |
| notes/item_id フィールド名不一致 | 修正済み |
| 補充/調整ボタン405エラー | 修正済み（Edit画面へ遷移+モーダル自動表示） |
| logDeleted引数不足 | 修正済み |

### Phase 5 タイムカード

| 指摘 | 重要度 | 対応 |
|------|--------|------|
| ルートモデルバインディング不一致 | 重大 | `{timeRecord}` に統一 |
| 月別フィルタ不動作 | 重大 | `parseYearMonth()` でYYYY-MM形式をパース |
| 時刻バリデーション | 重大 | `date_format:H:i` に変更、日付と結合 |
| `modified_by_user` 未定義 | 中 | アクセサ追加 |
| 時刻表示崩れ | 中 | `new Date()` + `toLocaleTimeString` に変更 |
| 休憩複数回可能 | 低 | 2回目以降をブロック |

### Phase 6 お知らせ

| 指摘 | 重要度 | 対応 |
|------|--------|------|
| ルート順序で/createが到達不能 | 重大 | /createを{announcement}より先に定義 |
| 下書きが一覧に出ない | 中 | Manager+は全件表示、下書きバッジ追加 |
| N+1クエリ（is_read判定） | 低 | withExistsで一括判定 |

### Phase 7 シフト

| 重要度 | 指摘 | 対応 |
|--------|------|------|
| 重大 | Model の日跨ぎ計算が仕様と矛盾 | end <= start は無効データとして0/false返却 |
| 中 | Calendar.tsx の props 不一致 | 未使用の monthStart/monthEnd を削除 |
| 中 | 同時リクエストで重複が抜ける | DB::transaction + lockForUpdate 追加 |

### Phase 9 二要素認証

| 重要度 | 指摘 | 対応 |
|--------|------|------|
| 重大 | Google Charts API外部依存 | BaconQrCodeでローカルSVG生成に変更 |
| 重大 | リカバリーコード表示タイミング | 有効化直後にセッションフラグ設定 |
| 中 | Challenge.tsx nested form | router.post()でログアウト実装 |
| 中 | マイグレーションファイル欠落 | 条件付きカラム追加で再作成 |

---

## 5. 機能追加・改善履歴

### 2025年12月30日: 招待リンク運用改善 + プロフィール写真機能

**コミット:** `2421d2f`

**招待リンク改善:**
| 変更 | 詳細 |
|------|------|
| `invitee_name` 追加 | 招待者名を必須フィールドとして追加 |
| `email` 任意化 | メールアドレスを任意に変更 |
| URLコピーモーダル | 招待作成後にURLコピーモーダルを表示 |
| 登録画面改善 | 「○○さんの招待」ヘッダー表示 |

**プロフィール写真機能:**
| 変更 | 詳細 |
|------|------|
| 写真アップロード | プロフィール編集画面から写真をアップロード可能に |
| Google OAuth対応 | 既存のGoogle OAuth URLとローカルファイル両方に対応 |
| ゲストページ連携 | スタッフ写真をゲストページに表示 |

---

### 2025年12月31日: 外部予約連携準備

**予約カレンダーのモバイル対応:**
| 変更 | 詳細 |
|------|------|
| 月ナビゲーション | モバイルでflex-col配置に対応 |
| 凡例セクション | モバイルで2列グリッド表示 |
| タッチターゲット | 44px以上の最小高さを確保 |
| 日付詳細モーダル | 日付タップで予約詳細を表示 |

**チェックイン時間フィールド追加:**
- `banshirou_reservations`テーブルに`checkin_time`カラム追加
- 予約フォーム・詳細画面に表示追加

**外部予約データ連携（クライアント待ち）:**
- Googleカレンダーからの予約情報取得機能
- サービスアカウント方式で実装予定
- Google Cloud Console設定をクライアントに依頼中

---

### 2026年1月1日: Metamask連携機能

**コミット:** `026db5c`, `51e3aba`, `c0ccdb0`

**実装内容:**
| 機能 | 説明 |
|------|------|
| Metamask接続 | ボタンクリックでMetamaskからアドレスを自動取得 |
| 自動検証 | Metamask経由で取得したアドレスは自動的に「検証済み」 |
| 手動入力 | 従来通り`0x...`形式で直接入力も可能（未検証扱い） |
| 日本時間表示 | 登録日時をGMTから日本時間（Asia/Tokyo）に修正 |

**変更ファイル:**
- `app/Http/Controllers/StaffWalletController.php`
- `resources/js/Pages/Profile/Wallet.tsx`

---

## 6. バグ修正履歴

### 2026年1月1日: システム全体のコードレビューと500エラー修正

**コミット:** `ea36250`, `98ea7a9`, `ecaef92`

#### 高優先度修正

**1. ActivityLogService の NULL エラー**
- ファイル: `app/Services/ActivityLogService.php`
- 問題: 招待登録時に `Auth::login()` 直後に `Auth::id()` がNULL
- 修正: 明示的にユーザーIDを渡せるよう引数追加

**2. GuestPage リレーションの SQL エラー**
- ファイル: `app/Models/GuestPage.php`
- 問題: `belongsTo` に `where` 句を付けると間違ったテーブルをクエリ
- 修正: アクセサで振り分ける方式に変更

**3. Location モデルの shifts リレーション**
- ファイル: `app/Models/Location.php`
- 問題: マイグレーションで `shifts.location_id` が削除されたが参照が残存
- 修正: shifts() リレーションを削除

#### 中優先度修正

**4. MoccaReservationController のフィルタ未対応**
- 問題: フロントが `from/to` を送信しても `date` のみ対応
- 修正: `from/to` パラメータ対応を追加

**5. Reservation モデルの $appends 未設定**
- 問題: 計算属性がInertiaレスポンスに含まれない
- 修正: `$appends` に必要な属性を追加

---

### APIヘルスチェックテスト追加

**ファイル:** `tests/Feature/ApiHealthCheckTest.php`

31のテストケースで主要エンドポイントの500エラー発生有無を確認。

**実行方法:**
```bash
php artisan test --filter=ApiHealthCheckTest
```

---

## ディレクトリ構成（最終状態）

```
app/
├── Contracts/                    # インターフェース
├── Core/                         # コア機能
│   ├── BaseModule.php
│   └── ActivityLog/
├── Http/
│   ├── Controllers/Auth/
│   │   └── TwoFactorController.php
│   └── Middleware/
│       └── EnsureTwoFactorAuthenticated.php
├── Modules/
│   ├── Reservation/              # 予約
│   ├── Checklist/                # チェックリスト
│   ├── Inventory/                # 備品管理
│   ├── TimeCard/                 # タイムカード
│   ├── Announcement/             # お知らせ
│   └── Shift/                    # シフト
└── Services/
    └── ActivityLogService.php

resources/js/
├── Components/                   # 共通コンポーネント
├── Layouts/
│   └── AuthenticatedLayout.tsx
├── Pages/
│   ├── Reservations/
│   ├── Checklists/
│   ├── Inventory/
│   ├── TimeCard/
│   ├── Announcements/
│   ├── Shifts/
│   ├── Auth/TwoFactor/
│   └── ...
└── types/
    └── index.d.ts
```

---

## 注意事項（学んだ教訓）

### コードレビュー観点

1. **ルート関連**
   - ルートパラメータ名とコントローラー引数名の一致
   - `/create`などの固定パスは`{id}`パラメータより先に定義

2. **データ形式**
   - フロント送信形式とバックエンド受取形式の一致
   - バリデーションルールと実際のデータ形式の一致
   - フィールド名の一致（DB ↔ Model ↔ TypeScript）

3. **パフォーマンス**
   - N+1対策: `withExists`でboolean属性を一括取得
   - paginate() vs get()（フロントが配列前提の場合）

4. **マイグレーション**
   - インデックス削除はカラム削除の前に行う（SQLite互換性）

---

**アーカイブ完了**
