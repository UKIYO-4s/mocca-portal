# 外部予約連携機能（未実装・クライアント承認待ち）

**ステータス:** クライアント承認待ち
**作成日:** 2025年12月31日
**最終更新:** 2026年1月3日

---

## 概要

現在、予約情報はGoogle Apps Script (GAS) で管理されており、Googleカレンダーから予約データを取得しています。
この機能は、GASで取得した予約データをMocca Portalに自動連携し、ポータル内で一元管理できるようにするものです。

---

## 現状

### 現在のフロー
```
Googleカレンダー → GAS（定期実行） → スプレッドシート
                                    ↓
                            手動でポータルに入力
```

### 目標のフロー
```
Googleカレンダー → GAS（定期実行） → Mocca Portal API
                                    ↓
                            ポータルで自動表示
```

---

## 実装方針

### 方式: サービスアカウント方式

1. **Google Cloud Console でサービスアカウント作成**
   - クライアントが Google Cloud Console で設定
   - サービスアカウントのJSON鍵ファイルを取得

2. **Googleカレンダーへのアクセス権付与**
   - 対象カレンダーにサービスアカウントのメールアドレスを共有設定

3. **Laravel側の実装**
   - `google/apiclient` パッケージでAPI連携
   - 定期的にカレンダーイベントを取得
   - `banshirou_reservations` テーブルに保存

---

## クライアント対応事項（承認待ち）

### 必要な設定作業

| 項目 | 説明 | ステータス |
|------|------|-----------|
| Google Cloud Project作成 | 新規プロジェクト作成またはGASプロジェクトを使用 | 未着手 |
| Calendar API有効化 | Google Calendar APIを有効にする | 未着手 |
| サービスアカウント作成 | 認証用のサービスアカウントを作成 | 未着手 |
| JSON鍵ファイル取得 | サービスアカウントの認証情報をダウンロード | 未着手 |
| カレンダー共有設定 | サービスアカウントにカレンダーの閲覧権限を付与 | 未着手 |

### クライアントへの依頼内容

```
【Google Cloud Console 設定依頼】

1. Google Cloud Console (https://console.cloud.google.com) にアクセス
2. プロジェクトを作成または選択
3. 「APIとサービス」→「ライブラリ」→「Google Calendar API」を有効化
4. 「APIとサービス」→「認証情報」→「サービスアカウント作成」
5. サービスアカウント作成後、「鍵を追加」→「新しい鍵を作成」→「JSON」
6. ダウンロードしたJSONファイルを開発者に送付
7. Googleカレンダーの設定で、サービスアカウントのメールアドレス（xxx@xxx.iam.gserviceaccount.com）に「閲覧者」権限を付与
```

---

## 技術詳細

### 必要なパッケージ
```bash
composer require google/apiclient
```

### 環境変数（.env）
```env
GOOGLE_CALENDAR_ID=xxxxx@group.calendar.google.com
GOOGLE_SERVICE_ACCOUNT_JSON=/path/to/service-account.json
```

### 実装予定ファイル
```
app/
├── Services/
│   └── GoogleCalendarService.php    # カレンダーAPI連携
├── Console/Commands/
│   └── SyncReservationsCommand.php  # 定期同期コマンド
└── Http/Controllers/
    └── (既存のReservationControllerを拡張)

config/
└── google.php                        # Google API設定
```

### データマッピング（予定）

| Googleカレンダー | banshirou_reservations |
|-----------------|----------------------|
| summary (タイトル) | name |
| start.dateTime | checkin_date + checkin_time |
| end.dateTime | checkout_date |
| description | notes |
| extendedProperties | guest_count, meal_option など |

---

## 完了済みの準備作業

### 2025年12月31日実施
- [x] 予約カレンダーのモバイル対応
- [x] `checkin_time` カラムの追加
- [x] 日付詳細モーダルの実装

---

## 次のステップ

1. **クライアントからの承認・設定情報待ち**
   - サービスアカウントJSON鍵ファイル
   - 対象カレンダーID

2. **承認後の実装作業**
   - GoogleCalendarService の実装
   - 同期コマンドの実装
   - 差分同期ロジック（重複防止）
   - エラーハンドリング・リトライ機構

3. **テスト・本番デプロイ**
   - ステージング環境でのテスト
   - 本番カレンダーとの同期確認

---

## 関連ファイル

- `app/Modules/Reservation/Models/BanshirouReservation.php`
- `resources/js/Pages/Reservations/Banshirou/Index.tsx`
- `database/migrations/*banshirou_reservations*`

---

## 備考

- GASとの並行運用期間を設けることを推奨
- 初回同期時は既存データとの重複チェックが必要
- 同期頻度は15分〜1時間程度を想定（要調整）
