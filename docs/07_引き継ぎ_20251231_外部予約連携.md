# 引き継ぎ文書 - 2025年12月31日（外部予約連携）

## 完了した作業

### 1. 予約カレンダーのモバイル対応

**ファイル:** `resources/js/Pages/Reservations/Availability/Index.tsx`

| 変更 | 詳細 |
|------|------|
| 月ナビゲーション | モバイルでflex-col配置に対応 |
| 凡例セクション | モバイルで2列グリッド表示 |
| タッチターゲット | 44px以上の最小高さを確保 |
| 日付詳細モーダル | 日付タップで予約詳細を表示 |

### 2. チェックイン時間フィールド追加

**目的:** チェックイン時間を予約時に確認・記録

| ファイル | 変更内容 |
|----------|----------|
| `database/migrations/2025_12_31_045230_add_checkin_time_to_banshirou_reservations_table.php` | `checkin_time`カラム追加 |
| `app/Modules/Reservation/Models/BanshirouReservation.php` | fillableに追加 |
| `app/Modules/Reservation/Controllers/BanshirouReservationController.php` | バリデーション追加 |
| `resources/js/Pages/Reservations/Banshirou/Create.tsx` | 入力フォーム追加 |
| `resources/js/Pages/Reservations/Banshirou/Show.tsx` | 表示追加 |

### 3. デフォルトタブを食事予約に変更

**ファイル:** `resources/js/Pages/Reservations/Banshirou/Create.tsx`

- デフォルト値: `'banshirou'` → `'mocca'`
- タブ表示順序: 食事予約を先頭に配置

---

## 進行中の作業（クライアント待ち）

### 外部予約データ（名前・人数）のポータル連携

**背景:**
- 現在、外部サイト予約（じゃらん等）はGoogleカレンダーに自動登録されている
- カレンダーイベントのタイトル形式: `山田様(2名)`
- カレンダーイベントの説明欄に予約詳細（予約番号、名前、人数、食事等）が含まれる
- ポータルの予約カレンダーに名前・人数を表示したい

**調査結果:**

| GASファイル | 役割 | データソース |
|-------------|------|--------------|
| `空き状況API.js` | 空き状況を返す | Googleカレンダー（イベント数のみカウント） |
| `予約承認Webアプリ.js` | 直接予約の承認処理 | スプレッドシート |
| `じゃらん予約自動化.js` | じゃらんメール→カレンダー登録 | Gmail→カレンダー |
| `ばんしろう予約かんり.js` | フォーム予約→承認依頼 | スプレッドシート |

**重要な発見:**
- Googleカレンダーのイベントには名前・人数が**既に入っている**
- 現在の空き状況APIはイベントの数だけをカウントし、詳細を返していない

**選定した実装方法（セキュリティ重視）:**

```
[認証済みユーザー] → [ポータル] → [Laravel Backend] → [Google Calendar API]
                         ↑              ↓
                    認証チェック    サービスアカウント認証
```

公開GAS APIを使わず、LaravelバックエンドからGoogle Calendar APIを直接呼ぶ方式を採用。

---

## クライアントに依頼中の作業

### Google Cloud Console設定

**1. プロジェクト作成/選択**
- https://console.cloud.google.com/
- プロジェクト名例: `mocca-portal`

**2. Google Calendar APIを有効化**
- 「APIとサービス」→「ライブラリ」
- 「Google Calendar API」を検索→有効化

**3. サービスアカウント作成**
- 「APIとサービス」→「認証情報」
- 「認証情報を作成」→「サービスアカウント」
- 名前: `mocca-calendar-reader`

**4. JSONキー発行**
- サービスアカウントをクリック
- 「キー」タブ→「鍵を追加」→「新しい鍵を作成」→JSON

**5. カレンダー共有設定**
- Googleカレンダー「もっか予約管理ハブ」の設定
- 「特定のユーザーと共有」
- サービスアカウントのメール（`xxx@xxx.iam.gserviceaccount.com`）を追加
- 権限: 「予定の表示（すべての予定の詳細）」

---

## クライアント応答後の実装手順

### 1. Laravelにgoogle/apiclientをインストール
```bash
composer require google/apiclient
```

### 2. JSONキーを配置
```bash
# storage/app/google/service-account.json に配置
# .gitignoreに追加済みであることを確認
```

### 3. Google Calendar連携サービス作成
```php
// app/Services/GoogleCalendarService.php
// - カレンダーイベント取得
// - イベントタイトルから名前・人数をパース
// - 日付ごとの予約リストを返す
```

### 4. コントローラー更新
```php
// AvailabilityController に外部予約データを追加
// Inertia::render に externalReservations を渡す
```

### 5. フロントエンド更新
```tsx
// Index.tsx のカレンダーセルに外部予約の名前・人数を表示
```

---

## 関連情報

### Googleカレンダー情報
| 項目 | 値 |
|------|-----|
| カレンダー名 | もっか予約管理ハブ |
| カレンダーID | `561b8986548813caffc7ec842ea5bd2892cb73e609190bde79333aa68f955fb0@group.calendar.google.com` |

### スプレッドシート情報（参考）
| 項目 | 値 |
|------|-----|
| スプレッドシートID | `1ng_34VIV6r6RoeYSTAMteZQtgf7pIMb2irw-p3DexWY` |
| 用途 | 直接予約フォームのデータ保存 |

### イベントタイトル形式
```
山田様(2名)      # じゃらん予約
鈴木様(3名)      # 直接予約（承認済み）
```

---

## 本番環境状態

| 項目 | 状態 |
|------|------|
| 最新コミット | デプロイ済み |
| マイグレーション | 実行済み（checkin_time追加） |
| ビルド | 成功 |

**本番URL:** https://mocca.sd-create.jp

---

## 直近のコミット履歴

```
2421d2f feat: 招待リンク運用改善 + プロフィール写真機能
d668fde feat: マイウォレットページ追加 - QRコード付きウォレット表示
9b663a9 fix: 投げ銭統計をAdmin専用に戻し、JPYCリンクを追加
```

---

## 次のアクション

1. **クライアント待ち:** Google Cloud Console設定完了→JSONキー受領
2. **受領後:** Laravel側のGoogle Calendar API連携実装
3. **完了後:** 予約カレンダーに外部予約の名前・人数を表示
