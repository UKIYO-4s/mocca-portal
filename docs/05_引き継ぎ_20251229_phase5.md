# Mocca Portal 引き継ぎドキュメント

**作成日:** 2025年12月29日 22:00 JST
**作成者:** Claude Code (Opus 4.5)

---

## 1. プロジェクト概要

飲食店（もっか・ばんしろう）向けの業務管理ポータルシステム。

| 項目 | 値 |
|------|-----|
| フレームワーク | Laravel 12 + React + TypeScript + Inertia.js |
| DB | MySQL 8.x / MariaDB |
| 本番 | https://mocca.sd-create.jp |
| リポジトリ | https://github.com/UKIYO-4s/mocca-portal |

---

## 2. 完了済みPhase

| Phase | 内容 | 完了日 |
|-------|------|--------|
| Phase 1 | コア基盤（認証・権限） | 2025/12/29 |
| Phase 2 | コア拡張 + 予約モジュール | 2025/12/29 |
| Phase C | JPYC投げ銭システム | 2025/12/29 |
| Phase 3 | チェックリストモジュール | 2025/12/29 |
| Phase 4 | 備品管理モジュール | 2025/12/29 |
| Phase 5 | タイムカードモジュール | 2025/12/29 |

---

## 3. 未着手Phase

| Phase | 内容 | 優先度 | 備考 |
|-------|------|--------|------|
| Phase 6 | お知らせモジュール | 中 | スケルトン作成済み |
| Phase 7 | シフトモジュール | 中 | スケルトン作成済み |
| Phase 8 | Googleカレンダー連携 | 低 | 後回し |
| Phase 9 | 二要素認証 | 低 | 後回し |

---

## 4. 本日の実装内容（Phase 5 タイムカードモジュール）

### 4.1 作成ファイル

```
app/Modules/TimeCard/
├── Controllers/TimeCardController.php  # 10メソッド
├── Models/TimeRecord.php               # 勤怠レコード
└── TimeCardModule.php                  # ルート定義

database/migrations/
└── 2025_12_29_125154_create_time_records_table.php

resources/js/Pages/TimeCard/
├── Index.tsx     # 打刻画面（出勤/休憩/退勤ボタン）
├── History.tsx   # 自分の勤務履歴
├── Manage.tsx    # 管理者用一覧・修正
└── Reports.tsx   # 月次レポート
```

### 4.2 ルート一覧

| メソッド | パス | 機能 | 権限 |
|----------|------|------|------|
| GET | /timecard | 打刻画面 | 全員 |
| POST | /timecard/clock-in | 出勤打刻 | 全員 |
| POST | /timecard/clock-out | 退勤打刻 | 全員 |
| POST | /timecard/break-start | 休憩開始 | 全員 |
| POST | /timecard/break-end | 休憩終了 | 全員 |
| GET | /timecard/history | 履歴閲覧 | 全員 |
| GET | /timecard/manage | 管理画面 | Manager+ |
| GET | /timecard/reports | レポート | Manager+ |
| PUT | /timecard/records/{timeRecord} | 記録修正 | Manager+ |

### 4.3 データベース（time_records）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint | PK |
| user_id | bigint | FK → users |
| date | date | 日付（ユニーク制約: user_id + date） |
| clock_in | timestamp | 出勤時刻 |
| clock_out | timestamp | 退勤時刻 |
| break_start | timestamp | 休憩開始時刻 |
| break_end | timestamp | 休憩終了時刻 |
| break_minutes | int | 休憩時間（分） |
| notes | text | 備考 |
| modified_by | bigint | FK → users（修正者） |
| modified_at | timestamp | 修正日時 |

### 4.4 仕様決定事項

| 項目 | 決定内容 |
|------|----------|
| 休憩入力方法 | ボタン式（休憩開始/休憩終了） |
| 打刻制限 | 1日1回のみ |
| 休憩制限 | 1日1回のみ |
| CSV出力 | 不要（今回は実装しない） |

### 4.5 コードレビュー対応履歴

| 指摘 | 重要度 | 対応 |
|------|--------|------|
| ルートモデルバインディング不一致 (`{record}` vs `$timeRecord`) | 重大 | `{timeRecord}` に統一 |
| 月別フィルタ不動作（`month=YYYY-MM` vs `year`/`month`） | 重大 | `parseYearMonth()` でYYYY-MM形式をパース |
| 時刻バリデーション（`date` vs `H:i`） | 重大 | `date_format:H:i` に変更、日付と結合 |
| `modified_by_user` 未定義 | 中 | アクセサ追加 (`getModifiedByUserAttribute`) |
| 時刻表示崩れ (`substring(0,5)`) | 中 | `new Date()` + `toLocaleTimeString` に変更 |
| 休憩複数回可能 | 低 | 2回目以降をブロック |

### 4.6 その他修正

| ファイル | 修正内容 |
|----------|----------|
| Login.tsx | 「グーグル」→「Google」|
| Show.tsx | 「グーグル」→「Google」|

---

## 5. 開発環境

### 5.1 ローカル開発

```bash
# サーバー起動
composer dev  # または php artisan serve + npm run dev

# ビルド
npm run build

# マイグレーション
php artisan migrate
```

### 5.2 デプロイ

```bash
ssh root@100.103.127.122
cd /var/www/mocca-portal
git pull origin main
php artisan migrate --force
npm run build
php artisan config:cache
php artisan route:cache
```

### 5.3 テストアカウント

| メール | ロール |
|--------|--------|
| admin@mocca-portal.local | admin |
| manager@mocca-portal.local | manager |
| staff@mocca-portal.local | staff |

---

## 6. ディレクトリ構成

```
app/Modules/
├── Reservation/     # 予約 ✅
├── Checklist/       # チェックリスト ✅
├── Inventory/       # 備品管理 ✅
├── TimeCard/        # タイムカード ✅ ← 今回実装
├── Announcement/    # お知らせ（スケルトン）
└── Shift/           # シフト（スケルトン）

resources/js/Pages/
├── Reservations/    # 予約画面
├── Checklists/      # チェックリスト画面
├── Inventory/       # 備品管理画面
└── TimeCard/        # タイムカード画面 ✅ ← 今回作成
```

---

## 7. 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| CLAUDE.md | Claude Code向けガイド |
| docs/01_システム仕様書.md | 全体仕様・DB設計 |
| docs/02_実装計画書.md | 実装手順・コード例 |
| docs/03_進捗管理.md | 進捗・実行ログ |
| docs/04_引き継ぎ_20251229.md | Phase 4完了時点 |

---

## 8. 注意事項

1. **コードレビュー観点（TimeCard実装で発生した問題）**
   - ルートパラメータ名とコントローラー引数名の一致
   - フロント送信形式とバックエンド受取形式の一致
   - バリデーションルールと実際のデータ形式の一致
   - Eloquentリレーション名とJSON出力キー名の一致

2. **TimeCardモジュール固有**
   - 1日1レコード制約（user_id + date のユニーク）
   - 状態遷移: not_started → working → on_break → completed
   - `work_minutes` は computed attribute（$appends）

---

## 9. 次のアクション

1. Phase 6 お知らせモジュール実装
2. Phase 7 シフトモジュール実装
3. 必要に応じて Phase 8, 9 を検討

---

## 10. Git情報

```
最新コミット: ceecb68
ブランチ: main
リモート: origin/main (up to date)
```

---

**引き継ぎ完了**
